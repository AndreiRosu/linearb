"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var r=t(require("lodash")),n=require("@linearb/gitstream-core-js"),i=require("js-yaml"),a=require("nunjucks"),o=t(require("axios")),u=t(require("moment")),s=t(require("prettier")),c=require("child_process"),l=require("fs"),f=t(require("parse-diff")),p=require("@actions/core"),d=require("@amplitude/node"),v=require("@linearb/linode-common");function h(){h=function(){return e};var e={},t=Object.prototype,r=t.hasOwnProperty,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.asyncIterator||"@@asyncIterator",o=n.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function s(e,t,r,n){var i=Object.create((t&&t.prototype instanceof f?t:f).prototype),a=new _(n||[]);return i._invoke=function(e,t,r){var n="suspendedStart";return function(i,a){if("executing"===n)throw new Error("Generator is already running");if("completed"===n){if("throw"===i)throw a;return{value:void 0,done:!0}}for(r.method=i,r.arg=a;;){var o=r.delegate;if(o){var u=w(o,r);if(u){if(u===l)continue;return u}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if("suspendedStart"===n)throw n="completed",r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n="executing";var s=c(e,t,r);if("normal"===s.type){if(n=r.done?"completed":"suspendedYield",s.arg===l)continue;return{value:s.arg,done:r.done}}"throw"===s.type&&(n="completed",r.method="throw",r.arg=s.arg)}}}(e,r,a),i}function c(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=s;var l={};function f(){}function p(){}function d(){}var v={};u(v,i,(function(){return this}));var m=Object.getPrototypeOf,g=m&&m(m(E([])));g&&g!==t&&r.call(g,i)&&(v=g);var b=d.prototype=f.prototype=Object.create(v);function y(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function x(e,t){var n;this._invoke=function(i,a){function o(){return new t((function(n,o){!function n(i,a,o,u){var s=c(e[i],e,a);if("throw"!==s.type){var l=s.arg,f=l.value;return f&&"object"==typeof f&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,o,u)}),(function(e){n("throw",e,o,u)})):t.resolve(f).then((function(e){l.value=e,o(l)}),(function(e){return n("throw",e,o,u)}))}u(s.arg)}(i,a,n,o)}))}return n=n?n.then(o,o):o()}}function w(e,t){var r=e.iterator[t.method];if(void 0===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return l;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return l}var n=c(r,e.iterator,t.arg);if("throw"===n.type)return t.method="throw",t.arg=n.arg,t.delegate=null,l;var i=n.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,l):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,l)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function _(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function E(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,a=function t(){for(;++n<e.length;)if(r.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=void 0,t.done=!0,t};return a.next=a}}return{next:O}}function O(){return{value:void 0,done:!0}}return p.prototype=d,u(b,"constructor",d),u(d,"constructor",p),p.displayName=u(d,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,d):(e.__proto__=d,u(e,o,"GeneratorFunction")),e.prototype=Object.create(b),e},e.awrap=function(e){return{__await:e}},y(x.prototype),u(x.prototype,a,(function(){return this})),e.AsyncIterator=x,e.async=function(t,r,n,i,a){void 0===a&&(a=Promise);var o=new x(s(t,r,n,i),a);return e.isGeneratorFunction(r)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},y(b),u(b,o,"Generator"),u(b,i,(function(){return this})),u(b,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=E,_.prototype={constructor:_,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&r.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(r,n){return o.type="throw",o.arg=e,t.next=r,n&&(t.method="next",t.arg=void 0),!!n}for(var i=this.tryEntries.length-1;i>=0;--i){var a=this.tryEntries[i],o=a.completion;if("root"===a.tryLoc)return n("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),s=r.call(a,"finallyLoc");if(u&&s){if(this.prev<a.catchLoc)return n(a.catchLoc,!0);if(this.prev<a.finallyLoc)return n(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return n(a.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return n(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=e,o.arg=t,a?(this.method="next",this.next=a.finallyLoc,l):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),l},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),l}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;R(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:E(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=void 0),l}},e}function m(e,t,r,n,i,a,o){try{var u=e[a](o),s=u.value}catch(e){return void r(e)}u.done?t(s):Promise.resolve(s).then(n,i)}function g(e){return function(){var t=this,r=arguments;return new Promise((function(n,i){var a=e.apply(t,r);function o(e){m(a,n,i,o,u,"next",e)}function u(e){m(a,n,i,o,u,"throw",e)}o(void 0)}))}}function b(){return(b=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function x(e,t){var r="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(r)return(r=r.call(e)).next.bind(r);if(Array.isArray(e)||(r=function(e,t){if(e){if("string"==typeof e)return y(e,void 0);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?y(e,void 0):void 0}}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0;return function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var w,k="https://gtxblnqb99.execute-api.us-west-1.amazonaws.com/prod",R={REVIEW_TIME:k+"/v1/pulls/review-time",EXPERT_REVIWER:k+"/gs/v1/data-service/expert-reviewer"},_="gitstream-rules-parser",E={FAILED_RENDER_STRING:_+" - failed render string",FAILED_YAML_LOAD:_+" - failed yaml.load",INVALID_CM:_+" - invalid cm",INVALID_CM_CONTEXT_VARIABLES:_+" - ContextVariableValidator"},O=["reviewers","reviewers","team_reviewers","labels"],S=function(e,t){return null==e?void 0:e.includes(t)},j=function(e,t,r){return void 0===r&&(r=!1),"string"==typeof t&&t.startsWith("r/")&&(t=(t=t.substring(2).slice(0,-1)).replace("\\/","/")),new RegExp(t,r?"m":"").test(e)},F=function(e,t){var r=null==e?void 0:e.map((function(e){return Boolean(e)}));return!(null==r||!r.length)&&r.every((function(e){return e===t}))},C=function(e){return"string"==typeof e?e.includes(",")?e.split(","):[e]:null!=e?e:[]},N=((w={}).github="GitHub",w.gitlab="GitLab",w.bitbucket="BitBucket","\n \nTo learn more about /:\\ gitStream - [Visit our Docs](https://docs.gitstream.cm/) \n \n"),L={"01":"JAN","02":"FEB","03":"MAR","04":"APR","05":"MAY","06":"JUN","07":"JUL","08":"AUG","09":"SEP",10:"OCT",11:"NOV",12:"DEC"},A=function(){};A.filters={};var I,B,T=function(e,t){var r;A.filters=b({},A.filters,((r={})[e]={args:t},r))},D=function(e,t,r,n,i){return r?S(t?e[t]:e,r):n?j(t?e[t]:e,n):i.some((function(r){return S(t?e[t]:e,r)}))},P=function(e,t,r,n){void 0===n&&(n=!1);var i=t.attr||"",a=t.term,o=t.regex,u=t.list,s=C(e);if(!a&&!o&&!u)return[];var c=u;return u&&(c=C(u)),"filterList"===r?function(e,t,r,n,i,a){return e.filter((function(e){return a?!D(e,t,r,n,i):D(e,t,r,n,i)}))}(s,i,a,o,c,n):function(e,t,r,n,i,a){return e.map((function(e){return a?!D(e,t,r,n,i):D(e,t,r,n,i)}))}(s,i,a,o,c,n)};!function(e){e.some="some",e.every="every",e.filter="filter",e.includes="includes",e.reject="reject",e.map="map",e.match="match",e.nope="nope",e.intersection="intersection",e.difference="difference"}(B||(B={}));var q,M,V,G,U,J=((I={})[B.some]=function(e){var t;T(B.some,[]);var r=null==(t=C(e))?void 0:t.map((function(e){return Boolean(e)}));return Boolean(null==r?void 0:r.length)&&r.some((function(e){return e}))},I[B.every]=function(e){return T(B.every,[]),F(C(e),!0)},I[B.filter]=function(e,t){return T(B.filter,[t]),P(e,t,"filterList")},I[B.reject]=function(e,t){return T(B.reject,[t]),P(e,t,"filterList",!0)},I[B.map]=function(e,t){var r=t.attr;return T(B.map,[{attr:r}]),C(e).map((function(e){return e[r]}))},I[B.includes]=function(e,t){T(B.includes,[t]);var r=t.term,n=t.regex,i=t.list;if(!r&&!n&&!i)return!1;var a=i;return i&&(a=C(i)),r?S(e,r):n?j(e,n):a.some((function(t){return e.includes(t)}))},I[B.match]=function(e,t){return T(B.match,[t]),P(e,t,"mapList")},I[B.nope]=function(e){return T(B.match,[]),F(C(e),!1)},I[B.intersection]=function(e,t){T(B.intersection,[t]);var n=t.list;return!!n&&r.intersection(e,n)},I[B.difference]=function(e,t){T(B.difference,[t]);var n=t.list;return!!n&&r.difference(e,n)},I),W={github:"",gitlab:"  \n",default:""},Y=function(e,t){return Object.keys(e).reduce((function(r,n){var i,a,o=e[n];return r[t[n]]&&(o=e[n]+r[t[n]]),b({},r,((a={})[null!=(i=t[n])&&i.includes("@")||!t[n]?n+"\\*":t[n]]=o,a))}),{})},H=function(e){return{blame:Object.keys(e.blame).reduce((function(t,r){var n;return b({},t,((n={})[r]=Y(e.blame[r],e.git_to_provider_user),n))}),{})}},Q=function(e,t){var r=Object.keys(t).length;return e.reduce((function(e,n){var i,a=function(e,t){return Object.values(e).reduce((function(e,r){var n,i,a=r[t],o=(null!=a?a:0)+(null!=(n=e[t])?n:0);return b({},e,o&&((i={})[t]=o,i))}),{})}(t,n);return b({},e,a[n]&&((i={})[n]=a[n]/r,i))}),{})},$=function(e,t){return e.sort((function(e,r){var n,i;return(null!=(n=t[r])?n:0)-(null!=(i=t[e])?i:0)}))},K=function(e,t,r){return Object.keys(e).length?function(e,t,r){var n=Object.keys(e).filter((function(n){return void 0!==t?e[n]>t:e[n]<r}));return $(n,e).reduce((function(t,r){var n;return r.includes("*")?t:b({},t,((n={})[r]=e[r],n))}),{})}(e,t,r):{}},X=function(e){return!!e.gt||!!e.lt},z=function(){var e=g(h().mark((function e(t){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.post(R.REVIEW_TIME,t,{headers:{"Content-type":"application/json"}});case 2:return e.abrupt("return",{numericValue:e.sent.data.numericValue});case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Z=function(){var e=g(h().mark((function e(t){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=6;break}return e.next=3,o.post(R.EXPERT_REVIWER,t,{headers:{"Content-type":"application/json"}});case 3:return e.abrupt("return",e.sent.data||{});case 6:return e.abrupt("return",{});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ee=function(e,t,r,n){var i=Object.keys(e).reduce((function(i,a){var o;return(void 0!==t?e[a][n]>t/100:e[a][n]<r/100)?b({},i,((o={})[a]=e[a],o)):i}),{});return Object.keys(i).filter((function(e){return!e.includes("@")&&!e.includes("<>")}))||[]},te=function(e){return e.gt||e.lt||.1},re=function(){var e=g(h().mark((function e(t){var r,n,i,a;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Z(null==(r=t.data_service)?void 0:r.expert_reviwer_request);case 2:if(n=e.sent,Object.keys(n).length){e.next=5;break}return e.abrupt("return",{data:{},dataWithoutIssuer:{},isIssuerFiltered:!1});case 5:return i=!1,a=Object.keys(n).reduce((function(e,r){var a;return r===t.pr_author?(i=!0,e):b({},e,((a={})[r]=n[r],a))}),{}),e.abrupt("return",{data:n,dataWithoutIssuer:a,isIssuerFiltered:i});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),ne=function(e,t,r,n,i,a){var o="🥷 **Code experts:";return o+=e.length?" "+e.join(", ")+"** \n \n":" no user "+(a?"but you":"")+" matched threshold "+n+"** \n \n",t.length&&(o+=t.join(", ")+" "+(1===t.length?"has":"have")+" most 👩‍💻 **activity** in the files. \n"+(W[i]||W.default)),r.length&&(o+=r.join(", ")+" "+(1===r.length?"has":"have")+" most 🧠 **knowledge** in the files. \n"),o},ie=function(e,t,r,n,i,a){try{var o="<details>\n <summary>See details</summary>\n\n";return e.forEach((function(e){o+="\n`"+e+"` \n "+function(e,t,r){return Object.keys(t).length?r.length?"\n\nActivity based on git-commit: \n\n |  | "+(r[0]?r[0]:" ")+" | "+(r[1]?r[1]+"| \n | --- | --- | --- | \n ":" \n | --- | --- | \n")+function(e,t,r){for(var n="",i=[],a=0;a<6;a++)i.push(L[u().subtract(a,"months").format("MM")]);return i.forEach((function(i){var a,o=e[t][r[0]][i],u=null==(a=e[t][r[1]])?void 0:a[i];n+="| "+i+" | "+(o?o.additions+" additions & "+o.deletions+" deletions":" ")+" |",n+=(u?u.additions+" additions & "+u.deletions+" deletions |":" ")+" \n"})),n}(t,e,r):"":"\n\nNo activity in the last 6 months\n\n"}(e,t,n)+" \n\nKnowledge based on git-blame: \n "+(W[a]||W.default)+function(e,t,r,n){var i="";return $(r,t[e]).forEach((function(r){i+=t[e][r]?r+": "+t[e][r]+"% \n"+(W[n]||W.default):""})),i}(e,r,i,a)})),o+="\n</details>\n"}catch(e){return console.log("Error in creating explain code experts comment",e),""}},ae=function(e,t){return Object.keys(e||{}).reduce((function(r,n){var i,a=function(e,t,r){return r.reduce((function(r,n){var i,a=function(e,t,r){return Object.keys(e[t]).reduce((function(n,i){var a,o;return e[t][i][r]?b({},n,((o={})[L[null==(a=i.split("-"))?void 0:a[1]]]=e[t][i][r],o)):n}),{})}(e,t,n);return b({},r,((i={})[n]=a,i))}),{})}(e,n,t);return b({},r,((i={})[n]=a,i))}),{})},oe=function(e,t){return Object.keys(e||{}).reduce((function(r,n){var i,a=$(t,e[n]).reduce((function(t,r){var i;return e[n][r]?b({},t,((i={})[r]=Math.round(100*e[n][r]),i)):t}),{});return b({},r,((i={})[n]=a,i))}),{})},ue=function(){var e=g(h().mark((function e(t,r){var n,i,a,o,u,s,c,l,f;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return T(U.estimatedReviewTime,[]),o=null==(n=t.diff)?void 0:n.files_metadata.length,u=null==(i=t.diff)?void 0:i.files_metadata.reduce((function(e,t){return e.additionalLines+=t.additions,e.deletedLines+=t.deletions,e}),{additionalLines:0,deletedLines:0}),s=u.additionalLines,c=u.deletedLines,l=null==(a=t.diff)?void 0:a.files_metadata.map((function(e){return{file_path:"/dev/null"!==e.new_file?e.new_file:e.original_file,additions:e.additions,deletions:e.deletions}})),f={prMetadata:{commits:t.num_of_commits,files:o,lines:s+c},prFiles:l,prAdditionalLines:s,prDeletedLines:c,baseBranch:t.base,request_source:"gitstream"},e.next=7,z(f);case 7:r(null,e.sent.numericValue);case 10:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),se=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u,s,c;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=void 0===(i=r.gt)?0:i,u=void 0===(o=r.lt)?0:o,e.prev=1,T(U.expertReviewer,[{gt:a,lt:u}]),e.next=5,re(t);case 5:s=e.sent.dataWithoutIssuer,Object.keys(s).length||n(null,[]),c=ee(s,a,u,"reviewer_score").slice(0,2),n(null,c),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(1),console.log("error:",e.t0),n(null,[]);case 16:case"end":return e.stop()}}),e,null,[[1,12]])})));return function(t,r,n){return e.apply(this,arguments)}}(),ce=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u,s,c,l,f,p,d,v,m,g,b,y;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=r.gt,u=r.lt,e.next=4,re(t);case 4:c=(s=e.sent).data,l=s.dataWithoutIssuer,f=s.isIssuerFiltered,Object.keys(c).length&&Object.keys(l).length||n(null,[]),p=ee(l,o,u,"reviewer_score").slice(0,2),d=ee(c,o,u,"avg_activity_score").slice(0,2),v=ee(c,o,u,"avg_blame_perc").slice(0,2),m=ae(null==(i=c.explain)?void 0:i.activity,d),g=oe(null==(a=c.explain)?void 0:a.blame,v),b=ne(p,d,v,te(r),t.provider,f&&!Object.keys(p).length)+" "+ie(Array.from(new Set([].concat(Object.keys(m),Object.keys(g)))),m,g,d,v,t.provider)+" \n\n "+N+" \n",y="base64: "+Buffer.from(b).toString("base64"),n(null,y),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(0),console.log("error:",e.t0),n("");case 23:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t,r,n){return e.apply(this,arguments)}}(),le=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return T(U.codeExperts,[{gt:a=void 0===(i=r.gt)?0:i,lt:u=void 0===(o=r.lt)?0:o}]),e.next=4,se(t,{gt:a,lt:u},n);case 4:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),fe=function(){var e=g(h().mark((function e(t,r,n){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return T(U.explainExpertReviewer,[r]),e.next=3,ce(t,r,n);case 3:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),pe=function(){var e=g(h().mark((function e(t,r,n){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return T(U.explainCodeExperts,[r]),e.next=3,ce(t,r,n);case 3:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),de=function(e){return e.replace(/\s+/g," ").replaceAll("'",'"').trim()},ve=function(e,t){return de(s.format(e,{semi:!1,singleQuote:!0,filepath:t}))},he={js:ve,ts:ve,html:ve,py:function(e){return c.spawnSync("python",["-c","import black; print(black.format_str("+JSON.stringify(e)+", mode=black.FileMode()))"]).stdout.toString().replace(/^\s*[\r\n]/gm,"")},default:de},me=function(e,t){var n,i=null!=(n=t.split(".").pop())?n:"";return r.get(he,i,he.default)(e,t)},ge=function(e){return Object.keys(e).map((function(t){return t+"="+e[t]}))},be=/\[\d+ Bugs?\]/g,ye=/\[\d+ Vulnerabilit(?:ies|y)\]/g,xe=/\[\d+ Security Hotspots?\]/g,we=/\[\d+ Code Smells?\]/g,ke=/\[(\d+(\.\d+)?|\.\d+)%\]/g,Re=/\[(\d+(\.\d+)?|\.\d+)%\]/g,_e=/!\[([A-Z])\]/g,Ee=function(e){var t,r=null==(t=e.match(_e))?void 0:t[0];return(null==r?void 0:r.substring(r.lastIndexOf("[")+1,r.indexOf("]")))||""},Oe=function(e,t,r){var n,i,a;void 0===r&&(r=!1);var o=null!=(n=r?parseFloat((null==(i=e.match(t))?void 0:i[0].split(/\s+/)[0].replace("[",""))||""):parseInt((null==(a=e.match(t))?void 0:a[0].split(/\s+/)[0].replace("[",""))||""))?n:null;return isNaN(o)?null:o},Se=function(e){T(U.sonarParser,[]);var t={bugs:{count:null,rating:""},code_smells:{count:null,rating:""},vulnerabilities:{count:null,rating:""},security_hotspots:{count:null,rating:""},duplications:null,coverage:null},r=e.comments.filter((function(e){return"sonarcloud"===e.commenter}));if(r.length){var n=r[0].content.split("\n");t.bugs={count:Oe(n[2],be),rating:Ee(n[2])},t.code_smells={count:Oe(n[5],we),rating:Ee(n[5])},t.vulnerabilities={count:Oe(n[3],ye),rating:Ee(n[3])},t.security_hotspots={count:Oe(n[4],xe),rating:Ee(n[4])},t.duplications=Oe(n[8],ke,!0),t.coverage=Oe(n[7],Re,!0)}return JSON.stringify(t)},je=function(e){var t=Fe();return e.conversations.forEach((function(e){var r,n,i,a,o,u,s,c,l,f,p,d,v=e.content.split("\n"),h=null==(r=v[0])||null==(n=r.split("**")[2])?void 0:n.trim(),m=null==(i=v[2])||null==(a=i.split("**")[2])?void 0:a.trim(),g=null==(o=v[4])||null==(u=o.split("**")[2])?void 0:u.trim(),b=null==(s=v[6])||null==(c=s.split("**")[2])?void 0:c.trim(),y=(null!=(l=null==(f=v[10])||null==(p=f.split("<summary>")[1])?void 0:p.split("</summary>")[0])?l:"").replace(/<b>/g,"").replace(/<\/b>/g,"");t.vulnerabilities.push({security_control:h,type:m,description:g,severity:b,summary:y}),t.metrics[b]=(null!=(d=t.metrics[b])?d:0)+1})),t},Fe=function(){return{vulnerabilities:[],metrics:{HIGH:null,MEDIUM:null,LOW:null,INFO:null}}},Ce={extractJitFindings:function(e){T(U.extractJitFindings,[]);var t=function(e){return e.reviews.filter((function(e){return"jit-ci"===e.commenter}))}(e),n=Fe();if(r.isEmpty(t))return JSON.stringify(n);var i=t.map(je);return JSON.stringify(function(e,t){return e.reduce((function(e,t){return console.log({acc:e,review:t}),b({},e,{vulnerabilities:[].concat(e.vulnerabilities,t.vulnerabilities),metrics:r.mergeWith(e.metrics,t.metrics,(function(e,t){return(e||0)+(t||0)}))})}),b({},t))}(i,n))}},Ne=function(e,t){return!!e.length&&function(e,t){return Boolean(e.length)&&e.map((function(e){return t.some((function(t){return(e||"").includes(t)}))})).every((function(e){return e}))}(e.map((function(e){return e.split(".").pop()||""})),t)},Le=function(e,t){if(T(U.rankByGitBlame,[t]),!X(t))return[];var r=t.gt,n=t.lt,i=H(e).blame,a=Q(Object.values(e.git_to_provider_user),i),o=K(a,r,n);return Object.keys(o).length?[].concat(Array.from(new Set(Object.keys(o)))):[]};!function(e){e.allDocs="allDocs",e.allImages="allImages",e.allTests="allTests",e.estimatedReviewTime="estimatedReviewTime",e.extensions="extensions",e.isFormattingChange="isFormattingChange",e.matchDiffLines="matchDiffLines",e.isFirstCommit="isFirstCommit",e.rankByGitBlame="rankByGitBlame",e.rankByGitActivity="rankByGitActivity",e.explainRankByGitBlame="explainRankByGitBlame",e.expertReviewer="expertReviewer",e.explainExpertReviewer="explainExpertReviewer",e.codeExperts="codeExperts",e.explainCodeExperts="explainCodeExperts",e.sonarParser="sonarParser",e.mapToEnum="mapToEnum",e.extractSonarFindings="extractSonarFindings",e.extractJitFindings="extractJitFindings"}(U||(U={}));var Ae,Ie,Be=((q={})[U.allDocs]=["requirements.txt"],q),Te=((M={})[U.allDocs]=["md","mkdown","txt","rst",".adoc"],M[U.allImages]=["svg","png","gif"],M[U.allTests]=["test","spec"],M),De=b(((V={})[U.allDocs]=function(e){return T(U.allDocs,[]),Boolean(e.length)&&e.every((function(e){return Be[U.allDocs].every((function(t){return!(e.includes("/"+t)||e===t)}))}))&&Ne(e,Te[U.allDocs])},V[U.allImages]=function(e){return T(U.allImages,[]),Ne(e,Te[U.allImages])},V[U.allTests]=function(e){return T(U.allTests,[]),function(e,t){var r=new RegExp("[^a-zA-Z0-9]("+Te[U.allTests].join("|")+")[^a-zA-Z0-9]");return Boolean(e.length)&&e.map((function(e){return r.test(e||"")})).every((function(e){return e}))}(e)},V[U.estimatedReviewTime]=ue,V[U.extensions]=function(e){return T(U.extensions,[]),e.map((function(e){return e.split(".").pop()})).filter((function(e,t,r){return r.indexOf(e)===t}))},V[U.isFormattingChange]=function(e){try{return T(U.isFormattingChange,[]),Boolean(e.length)&&e.every((function(e){var t=e.original_content,r=e.original_file;return me(e.new_content,e.new_file)===me(t,r)}))}catch(e){return!1}},V[U.matchDiffLines]=function(e,t){T(U.matchDiffLines,[t]);var r=t.regex,n=t.ignoreWhiteSpaces,i=new RegExp("^[+-]"),a=new RegExp("^[+-]\\s*$");return r?e.map((function(e){return e.diff.split("\n").filter((function(e){return i.test(e)})).filter((function(e){return!n||!a.test(e)})).map((function(e){return j(e,r)}))})).flat(1):[]},V[U.isFirstCommit]=function(e,t){return T(U.isFirstCommit,[{author:t}]),!r.get(e,t,null)},V[U.rankByGitBlame]=Le,V[U.rankByGitActivity]=function(e,t){T(U.rankByGitActivity,[t]);var r=t.gt,n=t.lt,i=t.weeks;if(!r&&!n||!i)return[];var a=new Array(i+1).fill(0).map((function(e,t){return"week_"+t})),o=function(e,t){return Object.keys(e).reduce((function(r,n){var i,a=Object.values(e[n]).reduce((function(e,r){return t.forEach((function(t){var n,i=r[t];i&&(e[t]=(null!=(n=e[t])?n:0)+i)})),b({},e)}),{});return b({},r,((i={})[n]=a,i))}),{})}(e.git_activity,a),u=function(e,t,r){return Object.keys(e).reduce((function(n,i){var a,o=Object.keys(e[i]).reduce((function(n,a){var o,u=[];t.forEach((function(t){r[i][t]&&e[i][a][t]&&u.push(e[i][a][t]/r[i][t]*100)}));var s=u.reduce((function(e,t){return e+t}),0)/u.length;return b({},n,u.length&&((o={})[a]=parseInt(null==s?void 0:s.toFixed(0)),o))}),{});return b({},n,((a={})[i]=o,a))}),{})}(e.git_activity,a,o),s=Q(Object.keys(e.contributors),u),c=Y(s,e.git_to_provider_user),l=K(c,r,n);return Object.keys(l).length?[].concat(Array.from(new Set(Object.keys(l)))):[]},V[U.explainRankByGitBlame]=function(e,t){if(T(U.explainRankByGitBlame,[t]),!X(t))return{};var n=Le(e,t),i=r.filter(n,(function(t){return t!==e.pr_author})),a=i.join(", "),o=!i.length&&n.length>0,u=function(e){var t=H(e).blame;return Object.keys(t).reduce((function(e,r){var n;if("/dev/null"===r)return e;var i=$(Object.keys(t[r]),t[r]).reduce((function(e,n){var i;if(!t[r][n])return e;var a=n.replace(/\"\“/g,"").replace("“",""),o=(Math.floor(t[r][n])?Math.floor(t[r][n]):"<1")+"%";return e[a]&&parseInt(e[a])>parseInt(o)&&(o=e[a]),b({},e,((i={})[a]=o,i))}),{});return b({},e,((n={})[r]=i,n))}),{})}(e);return"base64: "+Buffer.from(function(e,t,r,n,i){var a=e.gt,o=a?"more than "+a+"%":"less than "+e.lt+"%",u=Object.keys(r).length,s=function(e,t,r,n){return e?" 👋  **Suggested reviewers: "+e+"**\n \nThey contributed "+t+" of the lines on pre-existing files":" 👋  **Suggested reviewers: no user "+(n?"but you":"")+" matched**\n \nNo "+(r?"other ":"")+"user contributed "+t+" of the lines on pre-existing files"}(t,o,u,i);s+=u?":\n":". \n ",s+=Object.keys(r).length?"<details>\n <summary>See details</summary>\n":"",s+="\n",Object.keys(r).forEach((function(e){0!==Object.keys(r[e]).length&&(s+="\n`"+e+"` \n"+(W[n]||W.default),Object.keys(r[e]).forEach((function(t){s+=t+": "+r[e][t]+" \n"+(W[n]||W.default)})))})),s+="\n</details>\n";var c=Object.values(r).map((function(e){return Object.keys(e).some((function(e){return e.includes("*")}))})).some((function(e){return e}));return s+=c?" \nGit users that could not be automatically mapped are marked with `*`.\n"+(W[n]||W.default)+"To map these users, refer to the instructions [here](https://docs.gitstream.cm/cm-file#config).\n \n":"",s+=N}(t,a,u,e.provider,o)).toString("base64")},V[U.expertReviewer]=se,V[U.explainExpertReviewer]=fe,V[U.codeExperts]=le,V[U.explainCodeExperts]=pe,V[U.sonarParser]=Se,V[U.mapToEnum]=function(e,t){T(U.mapToEnum,[e,t]);var r=null==t?void 0:t.enum;if(r&&Object.keys(r).length)return r[e]},V[U.extractSonarFindings]=function(e){return T(U.extractSonarFindings,[]),Se(e)},V),Ce),Pe=((G={})[U.estimatedReviewTime]=!0,G[U.expertReviewer]=!0,G[U.explainExpertReviewer]=!0,G[U.codeExperts]=!0,G[U.explainCodeExperts]=!0,G),qe=function(e,t){return e.length&&e.map((function(e){return t.some((function(t){return(e||"").includes(t)}))})).every((function(e){return!0===e}))},Me=function(e){return e.replace(/\s+/g," ").replaceAll("'",'"').trim()};!function(e){e.allExtensions="allExtensions",e.includes="includes",e.allPassRegex="allPassRegex",e.allPathIncludes="allPathIncludes",e.filterRegex="filterRegex",e.includesRegex="includesRegex",e.true="true",e.allFormattingChange="allFormattingChange",e.filterList="filterList",e.filterListRegex="filterListRegex",e.isEveryInListRegex="isEveryInListRegex",e.isSomeInList="isSomeInList",e.isSomeInListRegex="isSomeInListRegex",e.isStringIncludes="isStringIncludes",e.isStringIncludesRegex="isStringIncludesRegex",e.isEveryInList="isEveryInList",e.extractExtensions="extractExtensions",e.isEveryExtension="isEveryExtension",e.isEveryExtensionRegex="isEveryExtensionRegex",e.filterFileDiffRegex="filterFileDiffRegex",e.isEveryLineInFileDiffRegex="isEveryLineInFileDiffRegex",e.isSomeLineInFileDiffRegex="isSomeLineInFileDiffRegex"}(Ie||(Ie={}));var Ve,Ge,Ue=((Ae={})[Ie.filterList]=function(e,t){return!!e.length&&e.filter((function(e){return t.includes(e)}))},Ae[Ie.filterListRegex]=function(e,t){var r=new RegExp(t);return!!e.length&&e.filter((function(e){return r.test(e)}))},Ae[Ie.isEveryInListRegex]=function(e,t){var r=new RegExp(t);return!!e.length&&e.map((function(e){return r.test(e)})).every((function(e){return e}))},Ae[Ie.isSomeInList]=function(e,t){return!!e.length&&e.filter((function(e){return t.includes(e)})).some((function(e){return e}))},Ae[Ie.isSomeInListRegex]=function(e,t){var r=new RegExp(t);return!!e.length&&e.map((function(e){return r.test(e)})).some((function(e){return e}))},Ae[Ie.isStringIncludes]=function(e,t){return t.some((function(t){return e.includes(t)}))},Ae[Ie.isStringIncludesRegex]=function(e,t){return new RegExp(t).test(e)},Ae[Ie.isEveryInList]=function(e,t){return!!e.length&&e.filter((function(e){return t.includes(e)})).every((function(e){return e}))},Ae[Ie.extractExtensions]=function(e){return e.length&&e.map((function(e){return e.split(".").pop()})).filter((function(e,t,r){return r.indexOf(e)===t}))},Ae[Ie.isEveryExtension]=function(e,t){return qe(e.map((function(e){return e.split(".").pop()||""})).filter((function(e,t,r){return r.indexOf(e)===t})),t)},Ae[Ie.isEveryExtensionRegex]=function(e,t){var r=new RegExp(t),n=e.map((function(e){return e.split(".").pop()||""})).filter((function(e,t,r){return r.indexOf(e)===t}));return n.length>0&&n.map((function(e){return r.test(e)})).every((function(e){return e}))},Ae[Ie.true]=function(){return!0},Ae[Ie.filterFileDiffRegex]=function(e,t){var r=new RegExp(t,"m");return!!e.length&&e.filter((function(e){return r.test(e.diff)}))},Ae[Ie.isEveryLineInFileDiffRegex]=function(e,t){var r=new RegExp(t,"m");return!!e.length&&e.map((function(e){return r.test(e.diff)})).every((function(e){return e}))},Ae[Ie.isSomeLineInFileDiffRegex]=function(e,t){var r=new RegExp(t,"m");return!!e.length&&e.map((function(e){return r.test(e.diff)})).some((function(e){return e}))},Ae[Ie.allExtensions]=function(e,t){return!!e.length&&qe(e.map((function(e){return e.split(".").pop()||""})),t)},Ae[Ie.allPassRegex]=function(e,t){var r=new RegExp(t);return!!e.length&&e.map((function(e){return r.test(e)})).every((function(e){return e}))},Ae[Ie.allPathIncludes]=qe,Ae[Ie.filterRegex]=function(e,t){var r=new RegExp(t);return!!e.length&&e.filter((function(e){return r.test(e)}))},Ae[Ie.includesRegex]=function(e,t){var r=new RegExp(t);return!!e.length&&e.map((function(e){return r.test(e)})).some((function(e){return e}))},Ae[Ie.allFormattingChange]=function(e){try{return e.every((function(e){var t=e.original_content,r=e.original_file,n=s.format(e.new_content,{semi:!1,singleQuote:!0,filepath:e.new_file}),i=s.format(t,{semi:!1,singleQuote:!0,filepath:r});return Me(n)===Me(i)}))}catch(e){return!1}},Ae);!function(e){e.cbLeft="_GITSTREAM_CB_LEFT_",e.cbRight="_GITSTREAM_CB_RIGHT_",e.automations="automations",e.errors="errors",e.analytics="analytics",e.validatorErrors="validatorErrors"}(Ve||(Ve={})),function(e){e.FiltersValidator="FiltersValidator",e.ActionsValidator="ActionsValidator",e.FileStructureValidator="FileStructureValidator",e.SavedWordsValidator="SavedWordsValidator",e.ContextVariableValidator="ContextVariableValidator"}(Ge||(Ge={}));var Je,We=function(){function e(e,t,r){var n=this;this.renderedRuleFile={},this.context={},this.lastParserResult={},this.errors={},this.validatorErrors={},this.isDebug=r,this.env=new a.Environment(new a.FileSystemLoader(__dirname),{autoescape:!1});var i=b({},J,De,Ue);Object.keys(i).forEach((function(e){n.env.addFilter(e,i[e],Pe[e])})),this.context=t,this.ruleFileRawContent=e,this.isDebug&&console.log({context:JSON.stringify(this.context,null,2),ruleFile:e})}var t=e.prototype;return t.render=function(){var e=g(h().mark((function e(t){var r,n,a,o=this;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===t&&(t=b({},this.context,this.renderedRuleFile)),r=3,n=t,a=h().mark((function e(){var t;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=o.ruleFileRawContent,e.next=3,new Promise((function(e,r){return o.env.renderString(t,n,(function(t,n){if(t)return o.isDebug&&console.log(E.FAILED_RENDER_STRING,t),void r(t);try{o.renderedRuleFile=i.load(n)}catch(e){var a;o.isDebug&&console.log(E.FAILED_YAML_LOAD,e),o.renderedRuleFile=b({},o.renderedRuleFile,{errors:b({},Object.keys(o.errors).length&&o.errors,(a={},a[81]=E.FAILED_YAML_LOAD,a))})}e(o)}))}));case 3:r-=1,n=b({},o.context,o.renderedRuleFile);case 5:case"end":return e.stop()}}),e)}));case 4:if(!r){e.next=8;break}return e.delegateYield(a(),"t0",6);case 6:e.next=4;break;case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),t.validateRun=function(e){return e?e.map((function(e){if(!e.args)return e;var t=Object.keys(e.args).reduce((function(t,r){var n,i=e.args[r];return b({},t,((n={})[r]=i&&O.includes(r)&&"string"==typeof i?i.split(","):e.args[r],n))}),{});return b({},e,{args:t})})):e},t.combineMetadataWithRulesResult=function(e){var t=this;return this.renderedRuleFile[e]?Object.keys(this.renderedRuleFile[e]).reduce((function(r,n){var i,a=t.renderedRuleFile[e][n].if.map((function(e){return{passed:e}})),o=a.map((function(e){return e.passed})).every((function(e){return"object"==typeof e?!!Object.keys(e||{}).length:!!e}));return b({},r,((i={})[n]={if:a,run:t.validateRun(t.renderedRuleFile[e][n].run),passed:o},i))}),{}):{}},t.combineMetadataWithResult=function(){var e;return this.lastParserResult=((e={})[Ve.errors]=b({},Object.keys(this.errors).length&&this.errors),e[Ve.validatorErrors]=b({},Object.keys(this.validatorErrors).length&&this.validatorErrors),e[Ve.automations]=b({},this.combineMetadataWithRulesResult(Ve.automations)),e[Ve.analytics]=b({},Object.keys(A.filters).length&&A.filters),e),this.lastParserResult},t.clearParserResults=function(){this.renderedRuleFile={},this.ruleFileRawContent="",this.lastParserResult={}},t.attachAdditionalArgs=function(){var e=g(h().mark((function e(){var t,i,a,o,u,s,c;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=r.cloneDeep(this.lastParserResult),i=b({},t.automations),a=0,o=Object.keys(i);case 3:if(!(a<o.length)){e.next=19;break}u=x(i[o[a]].run);case 6:if((s=u()).done){e.next=16;break}if((c=s.value).action!==n.validatorsConstants.SUPPORTED_ACTIONS.EXPLAIN_CODE_EXPERTS){e.next=14;break}return this.clearParserResults(),this.ruleFileRawContent="comment: |\n          {{ repo | explainCodeExperts("+ge(c.args)+") }}",e.next=13,this.render();case 13:c.args.comment=this.renderedRuleFile.comment;case 14:e.next=6;break;case 16:a++,e.next=3;break;case 19:return this.lastParserResult=b({},t,{automations:i}),e.abrupt("return",this.lastParserResult);case 21:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),t.validateCM=function(){var e,t=this,r=((e={})[Ge.FiltersValidator]=new n.FiltersValidator,e[Ge.ActionsValidator]=new n.ActionsValidator,e[Ge.FileStructureValidator]=new n.FileStructureValidator,e[Ge.SavedWordsValidator]=new n.SavedWordsValidator,e[Ge.ContextVariableValidator]=new n.ContextVariableValidator,e);Object.keys(r).forEach((function(e){try{r[e].validate({yamlFile:t.ruleFileRawContent})}catch(r){var n;t.isDebug&&console.log(e+" error: ",r),t.validatorErrors=b({},Object.keys(t.validatorErrors).length&&t.validatorErrors,((n={})[e]=""+r,n))}}))},t.parseStreams=function(){var e=g(h().mark((function e(){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.validateCM(),e.next=3,this.render();case 3:return this.combineMetadataWithResult(),e.next=6,this.attachAdditionalArgs();case 6:return e.abrupt("return",this.lastParserResult);case 7:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e}(),Ye=process.env.RULES_RESOLVER_URL,He=process.env.HEAD_REF,Qe=process.env.BASE_REF,$e=process.env.CLIENT_PAYLOAD||"{}",Ke=process.env.RULES_RESOLVER_TOKEN,Xe="true"===process.env.DEBUG_MODE,ze="true"===process.env.USE_CACHE,Ze=[/.*.cm$/],et={APPROVALS:"approvals",CHECKS:"checks",DRAFT:"draft",DESCRIPTION:"description",REVIEWERS:"reviewers",STATUS:"status",TITLE:"title",LABELS:"labels"},tt={sonarParser:/\bpr\s*\|\s*sonarParser\b/g,extractSonarFindings:/\bpr\s*\|\s*extractSonarFindings\b/g},rt=function(){var e=g(h().mark((function e(t){var r,n,i,a;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=JSON.parse($e),n=r.ddApiKey,a=b({},t,{env:i=r.env,ddtags:"env:"+i,host:"gitstream-github-action"}),e.prev=2,e.next=5,o({method:"post",url:"https://http-intake.logs.datadoghq.com//api/v2/logs?dd-api-key="+n+"&ddsource=nodejs&service=gitstream-rules-engine",data:a,headers:{"Content-type":"application/json"}});case 5:return e.abrupt("return",e.sent);case 9:e.prev=9,e.t0=e.catch(2),console.error("Failed sending logs to datadog");case 12:case"end":return e.stop()}}),e,null,[[2,9]])})));return function(t){return e.apply(this,arguments)}}(),nt=function(e){Xe&&console.log(e)},it=function(){var e=g(h().mark((function e(t,r,n,i,a){var o,u,s,c,l;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===i&&(i={}),void 0===a&&(a=!1),!Xe&&!a){e.next=6;break}return o=n.owner,u=n.repo,s=n.pullRequestNumber,c=n.branch,l=n.triggeredBy,e.next=6,rt({level:t,message:r,data:b({},Object.keys(i).length&&i,{org:o,repo:u,pullRequestNumber:s,branch:c,triggeredBy:l})});case 6:case"end":return e.stop()}}),e)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}(),at=function(e){return"git blame '"+e.branch+"' --line-porcelain -- '"+e.file+"'"},ot=function(e){return"git log --no-merges '"+e.branch+"' --since='"+e.since+"' --pretty=tformat:'%an <%ae>,%ad' --numstat -- '"+e.file+"'"},ut={DEFAULT:"repo",CM:"cm"},st=function(e){return e.reduce((function(e,t,r){var n=r>0&&e.find((function(e){return e.git_user===t.git_user&&e.week===t.week}));return n?(n.changes+=t.changes,n.week=t.week):e.push({git_user:t.git_user,week:t.week,changes:t.changes}),e}),[]).reduce((function(e,t){var r,n=t.git_user,i=t.week,a=t.changes;return e[n]=e[n]||{},e[n]=b({},e[n],((r={})["week_"+i]=a,r)),b({},e)}),{})},ct=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u,s;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=6;break}return i=n.owner,a=n.repo,o=n.pullRequestNumber,nt("Couldn't find git dates for author: "+r.branch.author+", base branch: "+r.branch.base+", head branch: "+r.branch.name),e.next=5,it("info","No data returned from git in pr "+i+"/"+a+"/"+o,n,{author:r.branch.author,baseBranch:r.branch.base,headBranch:r.branch.name},Xe);case 5:return e.abrupt("return",0);case 6:return u=new Date,s=new Date(t),e.abrupt("return",Math.abs(parseInt((s-u)/864e5,10)));case 9:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),lt=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u,s,c,l,f,p,d,v,m,g,b;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("/dev/null"!==t){e.next=2;break}return e.abrupt("return");case 2:return i=n.owner,a=n.repo,o=n.pullRequestNumber,u=at({file:t,branch:r}),s=ot({file:t,branch:r,since:"52 weeks ago"}),c="git log -- '"+{file:t}.file+"'",e.prev=6,v=null==(l=Ut(u))?void 0:l.replace(/\n/g,"\\n"),m=null==(f=Ut(s))||null==(p=f.split("\n"))?void 0:p.filter(Boolean),g=null==(d=Ut(c))?void 0:d.replace(/\n/g,"\\n"),b={file:t,gitBlameCommand:u,gitActivityCommand:s,gitLogCommand:c,gitBlame:v,gitActivity:m,gitLog:g},e.next=13,it("info","Raw git commands for file in pr "+i+"/"+a+"/"+o,n,b,Xe);case 13:e.next=18;break;case 15:return e.prev=15,e.t0=e.catch(6),e.abrupt("return");case 18:case"end":return e.stop()}}),e,null,[[6,15]])})));return function(t,r,n){return e.apply(this,arguments)}}(),ft=function(e,t){var r;return null==(r=Ht(e,t))?void 0:r.split(/\r\n|\r|\n/)},pt=function(e){var t=r.cloneDeep(e),n=Object.keys(t).reduce((function(e,r){var n;return b({},e,((n={})[r]=t[r].dsBlame,n))}),{});return Object.keys(t).forEach((function(e){t[e].dsBlame&&delete t[e].dsBlame})),{formattedBlame:t,dsBlame:n}},dt=function(e){var t=r.cloneDeep(e),n=Object.keys(t).reduce((function(e,r){var n;return b({},e,((n={})[r]=t[r].dsActivity,n))}),{});return Object.keys(t).forEach((function(e){t[e].dsActivity&&delete t[e].dsActivity})),{formattedActivity:t,dsActivity:n}},vt=function(e,t){var r,n,i;return null==(r=Ut("git log '"+(i={author:e,branch:t}).branch+"' --author='"+i.author+"' --format='%as' | sort | uniq"))||null==(n=r.split("\n"))?void 0:n.filter(Boolean)},ht=function(e,t,r){var n,i=Ut(ot({branch:e,since:t,file:r})),a=function(e){for(var t=[],r=0;r<e.length;r+=2){var n,i,a=null==(n=e[r+1])?void 0:n.split("\t"),o=null==(i=e[r])?void 0:i.split(",");if(o.length&&a.length){var s=o[1],c=parseInt(a[0])+parseInt(a[1]);if(s&&c){var l=new Date(s),f=u(l).format("YYYY-MM-DD"),p=u().diff(f,"weeks");t.push({git_user:o[0],week:p,changes:c})}}}return t}(null==i||null==(n=i.split("\n"))?void 0:n.filter(Boolean));return nt("temp activity: "+JSON.stringify(a)),{dsActivity:i,groupByWeek:st(a)}},mt=function(e,t){return b({},e.reduce((function(e,r){var n,i=function(e,t){try{var r,n=at({file:e,branch:t})+" | grep '^author-mail\\|^author ' | sed '$!N;s/\\n/ /'",i=Ut(n);return null==(r=[].concat(Array.from(new Set(null==i?void 0:i.replaceAll("author ","").replaceAll("author-mail ","").split("\n")))))?void 0:r.filter(Boolean)}catch(t){return console.log("Failed getting all authors of file "+e+". "+t),[]}}(r,t);nt("files authors: "+JSON.stringify(i));var a=function(e,t){try{var r=at({file:e,branch:t})+" | sed -n '/^author /,/^author-mail /p'";return Ut(r)}catch(t){return console.log("Failed getting git blame of file "+e+". "+t),"0"}}(r,t);return b({},e,((n={})[r]=i.reduce((function(e,n){var i,o,u,s=function(e,t,r,n){var i=parseInt(function(e,t,r){try{var n,i="author "+(null==t||null==(n=t.substring(0,t.indexOf("<")-1))?void 0:n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"))+"\\nauthor-mail "+(null==t?void 0:t.substring(t.indexOf("<"),t.indexOf(">")+1).replace("+","\\+")),a=new RegExp(i,"g");return nt("formatted author: "+i+". matches: "+(e.match(a)||[]).length),(e.match(a)||[]).length}catch(e){return console.log("Failed getting author lines of file "+r+". "+e),"0"}}(e,t,r))||"",a=parseInt(function(e,t){var r,n;return function(e,t){var r=ft(e,t);return nt("all rows: "+r.length+". isEmpty: "+(""===(null==r?void 0:r[(null==r?void 0:r.length)-1]))),""===(null==r?void 0:r[(null==r?void 0:r.length)-1])}(e,t)?(null==(r=ft(e,t))?void 0:r.length)-1:null==(n=ft(e,t))?void 0:n.length}(r,n));return nt("calculateStatisticsForBlame: "+i+", "+a),{authorLines:i,allLinesCount:a}}(a,n,r,t);return b({},e,((i={})[n]=(u=s.allLinesCount,(o=s.authorLines)&&u?o>=u?100:100*parseFloat(o/u):0),i.dsBlame=a.replaceAll("\nauthor-mail"," author-mail"),i))}),{}),n))}),{}))},gt=function(e,t,r){var n;if(!e||"string"!=typeof e)return null;var i=e.includes("@")?e.split("@")[0]:e;return(i=(i=null!=(n=i)&&n.includes("+")?i.split("+")[1]:i).replace(/\./g,"")).includes(r)||i.includes(t)||(null==t?void 0:t.includes(i))||r===i},bt=function(e,t){if(!t||!e||"string"!=typeof e||"string"!=typeof t)return!1;var r=t.trim().toLowerCase(),n=e.trim().toLowerCase();return null==n?void 0:n.includes(r)},yt=function(e){return e.map((function(e){return{login:e.login,name:e.name}})).filter((function(e){return e.login||e.name}))},xt=function(e){return Object.keys(e).map((function(t){var r=t.split(" ");return{email:r.pop(),login:r.join(""),name:r[0],lastName:r[1],fullName:r.join(" "),reversedName:(r[1]||"")+r[0],contributor:t,contributions:e[t]}}))},wt=function(){var t=g(h().mark((function t(r,n){var i,a,o,u,s,c,l;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,o=(null==r||null==(i=r.config)||null==(a=i.user_mapping)?void 0:a.reduce((function(e,t){var r,n,i=Object.keys(t)[0],a=null!=(r=t[i])?r:i;return b({},e,((n={})[i]=a,n))}),{}))||{},t.abrupt("return",o);case 5:return t.prev=5,t.t0=t.catch(0),s=n.owner,c=n.repo,l=n.pullRequestNumber,t.next=10,it("info","Failed to parse user_mapping for pr "+s+"/"+c+"/"+l,n,{error:null==(u=e)?void 0:u.message},!0);case 10:return console.log("Failed to parse user_mapping: ",e),t.abrupt("return",{});case 12:case"end":return t.stop()}}),t,null,[[0,5]])})));return function(e,r){return t.apply(this,arguments)}}(),kt=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u,s,c,l,f;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i=yt(t),a=xt(r),o={},u=[],a.forEach((function(e){var t=i.find((function(t){var r=t.login;return gt(e.email,r,t.name)||bt(e.login,r)}));t?o[e.contributor]=t.login:u.push(e)})),s=[].concat(u),u=[],s.forEach((function(e){var t=i.find((function(t){var r=t.name;return bt(e.fullName,r)||bt(e.reversedName,r)}));t?o[e.contributor]=t.login:u.push(e)})),u.forEach((function(e){o[e.contributor]=e.contributor})),e.abrupt("return",o);case 13:return e.prev=13,e.t0=e.catch(0),c=n.owner,l=n.repo,f=n.pullRequestNumber,e.next=18,it("info","Failed to match contributors for pr: "+c+"/"+l+"/"+f,n,{error:null==e.t0?void 0:e.t0.message},!0);case 18:return console.error("Failed to match contributors",e.t0),e.abrupt("return",{});case 20:case"end":return e.stop()}}),e,null,[[0,13]])})));return function(t,r,n){return e.apply(this,arguments)}}(),Rt=function(e,t){return Object.keys(t).reduce((function(r,n){var i,a;return b({},r,((a={})[n]=null!=(i=e[n])?i:t[n],a))}),{})},_t=function(){var e=g(h().mark((function e(t,r,n,i){var a,o,u,s,c;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=n.owner,o=n.repo,u=n.pullRequestNumber,t&&r){e.next=4;break}return console.error("matchContributors failed: not provided data"),e.abrupt("return",{});case 4:return e.next=6,it("info","Gitstream matchContributors got contributors for pr: "+a+"/"+o+"/"+u,n,{providerContributors:t,gitContributors:r},!0);case 6:return e.next=8,kt(t,r,n);case 8:return s=e.sent,e.next=11,wt(i,n);case 11:if(c=e.sent,!Object.keys(c).length){e.next=16;break}return e.next=15,it("info","got contributors from config for pr: "+a+"/"+o+"/"+u,n,{userMappingFromConfig:c},!0);case 15:return e.abrupt("return",Rt(c,s));case 16:return e.abrupt("return",s);case 17:case"end":return e.stop()}}),e)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),Et=[],Ot=function(){var e=g(h().mark((function e(t){var r,n,i,a;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(r=t||{}).gitlabCustomWebhookToken,i=r.webhook_url,a={context:t,status:"failed",repo:t.repo,owner:t.owner,pullRequestNumber:t.pullRequestNumber,webhookEvent:"checkUpdate",event_type:"gs_custom_checkfail"},e.prev=3,e.next=6,o.post(i,JSON.stringify(a),{headers:{"Content-Type":"application/json","x-gitlab-token":""+n,"x-gitlab-event":"checkUpdate"}});case 6:e.next=11;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("Failed sending inner webhook to gitstream-sls-pipeline");case 11:case"end":return e.stop()}}),e,null,[[3,8]])})));return function(t){return e.apply(this,arguments)}}(),St={github:function(e,t,r){p.setFailed(JSON.stringify({message:e,owner:null==t?void 0:t.owner,repo:null==t?void 0:t.repo,branch:null==t?void 0:t.branch},null,2))},gitlab:function(){var e=g(h().mark((function e(t,r,n){var i;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Ot(r);case 2:i=t.replace(/%0A/g,"\n"),console.error(i);case 4:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),default:function(e){return console.error(e)}},jt=function(){var e=g(h().mark((function e(t,r,n,i){var a,o,u,s;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===i&&(i=""),a=i?"Error in "+i.trim()+" - "+t:t,Yr){e.next=11;break}return o=JSON.parse($e),u=St[(n||o||{}).source]||St.default,e.next=8,u(a,n,i);case 8:process.exit(r),e.next=13;break;case 11:console.log("gitstream-core error: "+t),Et.push(((s={})[r]=""+t,s));case 13:case"end":return e.stop()}}),e)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),Ft=function(e){return Buffer.from(e,"base64").toString("utf-8")},Ct=function(e){var t={"pr.description":"pr.description | nl2br | dump | safe"};return Object.keys(t).reduce((function(e,r){return e.replaceAll(r,t[r])}),e)},Nt=function(e){var t,r,n,i,a;return b({},e,{description:Ft(e.description),general_comments:null==(t=e.general_comments)?void 0:t.map((function(e){return b({},e,{content:Ft(e.content)})})),line_comments:null==(r=e.line_comments)?void 0:r.map((function(e){return b({},e,{content:Ft(e.content)})})),comments:null==(n=e.comments)?void 0:n.map((function(e){return b({},e,{content:Ft(e.content)})})),reviews:null==(i=e.reviews)?void 0:i.map((function(e){var t;return b({},e,{content:Ft(e.content),conversations:null==(t=e.conversations)?void 0:t.map((function(e){return b({},e,{content:Ft(e.content)})}))})})),conversations:null==(a=e.conversations)?void 0:a.map((function(e){return b({},e,{content:Ft(e.content)})}))})},Lt=function(e){var t=e.to;return Ze.every((function(e){return!t.match(e)}))},At=function(e,t,r){return r.map((function(r){var n=r.from,i=r.to;return{original_file:"/dev/null"===n?"":n,new_file:i,diff:r.chunks.reduce((function(e,t){return e+t.content+"\n"+t.changes.map((function(e){return e.content})).join("\n")}),""),original_content:Wt(Jt(t,e),n),new_content:Wt(t,i)}}))},It=function(e){return e.map((function(e){var t=e.to,r=e.from;return{original_file:"/dev/null"===r?"":r,new_file:t,file:"/dev/null"!==t?t:r,deletions:e.deletions,additions:e.additions}}))},Bt=function(e){return(null==e?void 0:e.reduce((function(e,t){return e+t.additions+t.deletions}),0))||0},Tt=function(){var e=g(h().mark((function e(t,r,n){var a,o,u,s;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=i.load(r.replaceAll(/{{(.*?)}}|{(.*?)}|{%.*%}((.|\n)*){% endfor %}/g,"")),nt("cm parse result: "+JSON.stringify(a)),e.abrupt("return",a);case 6:return e.prev=6,e.t0=e.catch(0),o=t.owner,u=t.repo,s=t.pullRequestNumber,e.next=11,it("error","Failed to parse cm in pr "+o+"/"+u+"/"+s,t,{error:null==e.t0?void 0:e.t0.message,rules:r,ruleFile:n},!0);case 11:return console.error("Failed while parsing CM file, to extract CM config"),e.next=14,jt(null==e.t0?void 0:e.t0.message,60,t,n);case 14:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t,r,n){return e.apply(this,arguments)}}(),Dt=function(){var e=g(h().mark((function e(t,r){var n,i,a,o,u,s;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,i=mt(t.files,t.branch.base),a=pt(i),o=a.formattedBlame,u=a.dsBlame,e.next=5,ct((l=void 0,f=void 0,void 0===(c=t.branch.base)&&(c="develop"),null==(l=Ut("git rev-list --max-parents=0 '"+{branch:c}.branch+'\' --format="%cs"'))||null==(f=l.split("\n"))?void 0:f[1]),t,r);case 5:return s=e.sent,e.next=8,ct(null==(n=vt(t.branch.author,t.branch.base))?void 0:n[0],t,r);case 8:return e.abrupt("return",{age:s,author_age:e.sent,blame:o,ds_blame:u});case 12:return e.prev=12,e.t0=e.catch(0),nt("Error extracting blame: "+e.t0.message),e.next=17,jt("Failed getting PR context.",40,r);case 17:case"end":return e.stop()}var c,l,f}),e,null,[[0,12]])})));return function(t,r){return e.apply(this,arguments)}}(),Pt=function(){var e=g(h().mark((function e(t){var r,n;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,r=t.files.reduce((function(e,r){var n;if("/dev/null"===r)return e;var i=ht(t.branch.base,"52 weeks ago",r);return b({},e,((n={})[r]=b({},i.groupByWeek,{dsActivity:i.dsActivity}),n))}),{}),n=dt(r),e.abrupt("return",{git_activity:n.formattedActivity,ds_activity:n.dsActivity});case 6:return e.prev=6,e.t0=e.catch(0),nt("Error extrating activity: "+e.t0.message),e.next=11,jt("Failed getting PR context.",40,t.payload);case 11:case"end":return e.stop()}}),e,null,[[0,6]])})));return function(t){return e.apply(this,arguments)}}(),qt=function(){var e=g(h().mark((function e(t,r,n,i){var a,o,u,s,c,l;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=i.owner,u=i.repo,s=i.pullRequestNumber,c=f(t),r&&(c=null==(l=c)?void 0:l.filter(Lt)),null!=(a=c)&&a.length){e.next=6;break}return e.next=6,it("warn","No files changed in rules-engine context for pr: "+o+"/"+u+"/"+s,i,{diff:t,diffCommand:n},r);case 6:return e.abrupt("return",c);case 7:case"end":return e.stop()}}),e)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),Mt=function(e,t){try{var r=function(e,t){var r=e.branch.author,n={author:r,prevResults:[]};try{if(!Object.keys(e.repo.contributors).includes(r)){var i=Object.keys(t).filter((function(r){return t[r]===e.pr.author}));i.forEach((function(t){var r=vt(t,e.branch.base);1===r.length&&(n={author:t,prevResults:r}),i.length>1&&n.prevResults.length<=r.length&&(n={author:t,prevResults:r})}))}return n}catch(e){return nt("Failed getting the right author. Error: "+e),{}}}(e,t);return Object.keys(r).length?{gitName:r.author.split("<")[0].replace(/\s*$/,"")+"\n",gitEmail:"<"+r.author.split("<")[1],fullName:r.author}:r}catch(e){return nt("Failed getting the right author. Error: "+e),{}}},Vt=function(){var e=g(h().mark((function e(t,r,n,i,a,o){var u,s,c,l,f,p,d,v,m,g,y,w,k,R,_,E,O,S,j,F;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return void 0===o&&(o=!1),u=n.owner,s=n.repo,c=n.pullRequestNumber,e.prev=2,e.next=5,Tt(n,i,a);case 5:return p=Yt(t,r,f=e.sent),d=p.diff,v=p.diffCommand,e.next=9,qt(d,o,v,n);case 9:return m=e.sent,g=zt(t),y=Zt(t),w=er(t,r),k={branch:{name:r,base:t,author:w.fullAuthorName,autor_name:w.authorName,author_email:w.authorEmail,diff:{size:Bt(m),files_metadata:It(m)},num_of_commits:g},source:{diff:{files:At(t,r,m)}},repo:{name:s,contributors:y,owner:u},files:m.map((function(e){return e.to})),pr:Nt(n.prContext)},e.next=16,_t(k.pr.contributors,k.repo.contributors,n,f);case 16:return _=Mt(k,R=e.sent),Object.keys(_).length&&(k.branch.author=_.fullName,k.branch.author_name=_.gitName,k.branch.author_email=_.gitEmail),nt("context.branch: "+JSON.stringify(k.branch,null,2)),e.next=22,Dt(k,n);case 22:return E=e.sent,e.next=25,Pt(k);case 25:if(k.repo=b({},k.repo,{provider:n.source,git_to_provider_user:R},E,e.sent,{pr_author:k.pr.author}),nt("context.repo: "+JSON.stringify(k.repo,null,2)),!Xe){e.next=36;break}O=x(k.files);case 30:if((S=O()).done){e.next=36;break}return j=S.value,e.next=34,lt(j,t,n);case 34:e.next=30;break;case 36:return h=JSON.stringify({context:{repo:k.repo,files:k.files,branch:k.branch,pr:{contributors:null==(l=k.pr)?void 0:l.contributors}}}),F=Buffer.from(h).toString("base64"),e.next=39,it("info","rules-engine context for pr: "+u+"/"+s+"/"+c,n,{reducedContext:F,diffCommand:v},Xe);case 39:return e.abrupt("return",k);case 42:return e.prev=42,e.t0=e.catch(2),console.log({error:e.t0}),e.next=47,it("error","Failed getting PR context.",n,{error:null==e.t0?void 0:e.t0.message,ruleFile:a},!0);case 47:return e.next=49,jt("Failed getting PR context.",40,n,a);case 49:case"end":return e.stop()}var h}),e,null,[[2,42]])})));return function(t,r,n,i,a,o){return e.apply(this,arguments)}}(),Gt={cwd:"./code"},Ut=function(e,t){void 0===t&&(t=ut.DEFAULT),nt("Execute: "+e);try{return c.execSync("cd "+t+" && "+e,b({},Gt,{maxBuffer:524288e3})).toString()}catch(e){throw nt("Git command failed. reason: "+((null==e?void 0:e.message)||"unknown error")),((null==e?void 0:e.toString())||"").includes("bad revision")&&jt("Git command failed. reason: "+((null==e?void 0:e.message)||"unknown error"),67),e}},Jt=function(e,t){try{return Ut("git rev-list --boundary '"+e+"'...'"+t+'\' | grep "^-" | cut -c2- | tail -1').trim()||t}catch(e){return t}},Wt=function(e,t){try{return"/dev/null"===t?"":Ut("git show '"+e.trim()+"':'"+t.trim()+"'")}catch(e){return""}},Yt=function(e,t,r){try{var n,i,a,o="git diff '"+e+"'...'"+t+"' "+((null==r||null==(n=r.config)||null==(i=n.ignore_files)||null==(a=i.map((function(e){return"':(exclude)"+e+"'"})))?void 0:a.join(" "))||""),u=Ut(o);return nt({diff:u,logs:Ut("git log"),currBranch:Ut("git branch --show-current")}),{diff:u,diffCommand:o}}catch(e){return console.log("error getting diff: "+e),""}},Ht=function(e,t,r){void 0===r&&(r=ut.DEFAULT),Ut("git config --global --add safe.directory '*'");try{return r===ut.DEFAULT&&Ut("git show '"+t+"':'"+e+"' > '"+e+"'"),l.readFileSync("./code/"+r+"/"+e,"utf8")}catch(e){return""}},Qt=function(e,t){Ut("git checkout '"+e+"'");var r="cm"===(null==t?void 0:t.toLowerCase())?Ut("git ls-files '*.cm'"):Ut("git ls-files '.cm/*.cm'");return Ut("git checkout -"),r.split("\n").filter(Boolean)},$t=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u,s,c;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=[],a=0,o=Object.keys(t);case 2:if(!(a<o.length)){e.next=12;break}return s=o[a],e.next=6,Tt(n,t[s],s);case 6:((null==(c=e.sent)||null==(u=c.config)?void 0:u.ignore_repositories)||[]).includes(r)&&i.push(s);case 9:a++,e.next=2;break;case 12:return e.abrupt("return",i);case 13:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),Kt=function(e){Ut("git checkout "+e,ut.CM);var t=Ut("git ls-files '*.cm'",ut.CM);Ut("git checkout -",ut.CM);var r=t.split("\n").filter(Boolean);return Object.keys(r).length?r.reduce((function(t,r){var n;return b({},t,((n={})[r]=Ht(r,e,ut.CM),n))}),{}):[]},Xt=function(){var e=g(h().mark((function e(t,r){var n,i;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=Qt(t,r),!(Object.keys(n).length>0)){e.next=4;break}return i=n.reduce((function(e,r){var n;return b({},e,((n={})[r]=Ht(r,t),n))}),{}),e.abrupt("return",i);case 4:return e.abrupt("return",{});case 5:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),zt=function(e){return Number(Ut("git rev-list --count HEAD ^"+e).trim())},Zt=function(e){return Ut("git shortlog "+e+" -s -n -e").split("\n").reduce((function(e,t){var r,n=t.trim().split("\t"),i=n[1];return b({},e,i&&((r={})[i]=parseInt(n[0]),r))}),{})},er=function(e,t){try{var r=Ut("git log '"+e+"'..'"+t+'\' --format="%an" | tail -1'),n=Ut("git log '"+e+"'..'"+t+'\' --format="%ae" | tail -1'),i=(null==r?void 0:r.trim())+" <"+(null==n?void 0:n.trim())+">";return nt({fullAuthorName:i,currBranch:Ut("git branch --show-current")}),{fullAuthorName:i,authorName:r,authorEmail:n}}catch(e){return console.log("error getting branch author name: "+e),""}},tr=function(e,t,r){return Ut("git config --global --add safe.directory '*'"),"cm"===(null==r?void 0:r.toLowerCase())?Boolean(Ut("git diff '"+t+"'...'"+e+"' -- *.cm")):Boolean(Ut("git diff '"+t+"'...'"+e+"' -- .cm/*.cm"))},rr=function(e){try{l.writeFileSync("./code/cache.json",JSON.stringify(e))}catch(e){console.log("error saving cache",e)}},nr=function(){try{var e=l.readFileSync("./code/cache.json").toString();return JSON.parse(e)}catch(e){return console.warn("error loading from cache",e),{}}},ir=function(){function e(e){var t=e.repo,r=e.pullRequestNumber,n=e.branch,i=e.triggeredBy;this.org=e.owner,this.repo=t,this.pullRequestNumber=r,this.branch=n,this.triggeredBy=i}return e.prototype.get=function(){return{org:this.org,repo:this.repo,pullRequestNumber:this.pullRequestNumber,branch:this.branch,triggeredBy:this.triggeredBy}},e}(),ar=function(){function e(e,t,r){this.merge_dict=e,this.pr_files=t,this.context=r}return e.prototype.get=function(){return{merge_dict:this.merge_dict,pr_files:this.pr_files,context:this.context}},e}(),or=function(e,t,r){var n=new ir(r).get(),i=function(e,t){var r=t.reduce((function(t,r){var n,i,a;return"/dev/null"===r?t:b({},t,((a={})[r]=b({},{blame:(null==(n=e.ds_blame)?void 0:n[r])||""},{activity:(null==(i=e.ds_activity)?void 0:i[r])||""}),a))}),{});return Object.keys(r).reduce((function(e,t){var n;return Object.keys(r[t]).length?b({},e,((n={})[t]=r[t],n)):e}),{})}(e,t);return new ar(e.git_to_provider_user,i,n).get()},ur=function(){function e(e,t,r,n){var i,a,o,u,s,c=e.owner,l=e.repo,f=e.pullRequestNumber,p=e.hasCmRepo;this.filterName=t,this.user_id=(null==(i=n.repo)?void 0:i.provider)+"/"+c+"/"+l+"/"+f,this.args=r,this.repo=(null==(a=n.repo)?void 0:a.provider)+"/"+c+"/"+l,this.author=(null==(o=n.repo)?void 0:o.provider)+"/"+(null==(u=n.repo)?void 0:u.pr_author),this.org=(null==(s=n.repo)?void 0:s.provider)+"/"+c,this.pr_url=fr(n,{owner:c,repo:l,pullRequestNumber:f}),this.level=p?"Org":"Repo"}return e.prototype.get=function(){return{event_type:"gitstream-filter-function",user_id:this.user_id,event_properties:{filter_name:this.filterName,args:this.args,repo:this.repo,author:this.author,org:this.org,pr_url:this.pr_url,level:this.level}}},e}(),sr=function(){var e=g(h().mark((function e(t,r,n,i){var a;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Je||(Je=d.init((o=t).analyticsKey,{serverUrl:o.analyticsHttpApiUrl})),e.prev=1,a=new ur(t,r,n,i).get(),e.next=5,Je.logEvent(a);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(1),nt("Sending event to amplitude failed with the following error "+JSON.stringify(e.t0));case 10:case"end":return e.stop()}var o}),e,null,[[1,7]])})));return function(t,r,n,i){return e.apply(this,arguments)}}(),cr=function(){function e(e,t,r,n){var i,a,o,u,s=e.owner,c=e.repo,l=e.pullRequestNumber,f=e.hasCmRepo,p=e.trigger_id;this.filter_name=t,this.user_id=(null==(i=n.repo)?void 0:i.provider)+"-"+(null==(a=n.repo)?void 0:a.pr_author),this.args=r,this.repo=c,this.author=null==(o=n.repo)?void 0:o.pr_author,this.org=s,this.provider=null==(u=n.repo)?void 0:u.provider,this.pr_url=fr(n,{owner:s,repo:c,pullRequestNumber:l}),this.is_org_level=f,this.trigger_id=p}return e.prototype.get=function(){return{userId:this.user_id,event:"action_filter",properties:{filter_name:this.filter_name,args:this.args,repo:this.repo,author:this.author,git_org_name:this.org,git_provider:this.provider,pr_url:this.pr_url,is_org_level:this.is_org_level,trigger_id:this.trigger_id}}},e}(),lr=function(){var e=g(h().mark((function e(t,r,n,i){var a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=new v.SegmentClient({segmentServiceUrl:t.segmentServiceUrl,segment_write_key:t.segmentWriteKey}),o=new cr(t,r,n,i).get(),e.next=5,a.track(o);case 5:e.next=13;break;case 7:if(e.prev=7,e.t0=e.catch(0),console.error("Unable to call segment",e.t0),!(e.t0 instanceof Error)){e.next=13;break}return e.next=13,it("warn","Unable to call segment for pr "+(null==t?void 0:t.owner)+"/"+(null==t?void 0:t.repo)+"/"+(null==t?void 0:t.pullRequestNumber),t,{error:null==e.t0?void 0:e.t0.message},!0);case 13:case"end":return e.stop()}}),e,null,[[0,7]])})));return function(t,r,n,i){return e.apply(this,arguments)}}(),fr=function(e,t){var r,n=t.owner,i=t.repo,a=t.pullRequestNumber;return"github"===(null==(r=e.repo)?void 0:r.provider)?"github.com/"+n+"/"+i+"/pull/"+a:"gitlab.com/"+n+"/"+i+"/-/merge_requests/"+a},pr=function(){var e=g(h().mark((function e(t,r,n){var i,a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=x(Object.keys(t)||{});case 1:if((a=i()).done){e.next=9;break}return o=a.value,e.next=5,sr(r,o,t[o].args,n);case 5:return e.next=7,lr(r,o,t[o].args,n);case 7:e.next=1;break;case 9:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),dr=/^.*#.*$/gm,vr=/^\s*\n/gm,hr=/-.*action( )*:.*/gi,mr=/-.*action.*: /gi,gr=/{[\s]+{|}[\s]+}/gi,br=function(){var e=g(h().mark((function e(t,r,n){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.includes("automations:")){e.next=3;break}return e.next=3,jt("Missing `automations` keyword in *.cm",61,n,r);case 3:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),yr=function(){var e=g(h().mark((function e(t,r,i){var a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=Object.values(n.validatorsConstants.SUPPORTED_ACTIONS_BY_PROVIDER[i.source]||n.validatorsConstants.SUPPORTED_ACTIONS_BY_PROVIDER.default),!(o=t.filter((function(e){return!a.includes(e)}))).length){e.next=5;break}return e.next=5,jt("The following actions are not supported: "+o.map((function(e){return"`"+e+"`"})).join(", ")+" [Supported actions](https://docs.gitstream.cm/automation-actions/)",62,i,r);case 5:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),xr=function(){var e=g(h().mark((function e(t,r,n){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.match(gr)){e.next=3;break}return e.next=3,jt("There are spaces between the currly braces { { and } }",64,n,r);case 3:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),wr=function(){var e=g(h().mark((function e(t,r,i){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.forEach(function(){var e=g(h().mark((function e(t){var a,o,u;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.action,o=Object.keys(t.args||{}),u=function(e){return o.includes(e)},n.validatorsConstants.REQUIRED_ARGUMENTS_BY_ACTIONS[a]){e.next=5;break}return e.abrupt("return");case 5:if(!(n.validatorsConstants.REQUIRED_ARGUMENTS_BY_ACTIONS[a].all?!n.validatorsConstants.REQUIRED_ARGUMENTS_BY_ACTIONS[a].args.every(u):!n.validatorsConstants/n.validatorsConstants.REQUIRED_ARGUMENTS_BY_ACTIONS[a].args.some(u))){e.next=9;break}return e.next=9,jt("Missing required args for action: `"+a+"`: ["+n.validatorsConstants/n.validatorsConstants.REQUIRED_ARGUMENTS_BY_ACTIONS[a].args.filter((function(e){return!o.includes(e)})).map((function(e){return""+e})).join(", ")+"]",65,i,r);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),kr=function(){var e=g(h().mark((function e(t,r,i){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.forEach(function(){var e=g(h().mark((function e(t){var a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=t.action,null==(o=Object.keys(t.args||{}).filter((function(e){var t;return!(null!=(t=n.validatorsConstants.SUPPORTED_ARGUMENTS_BY_ACTION[a])&&t.includes(e))})))||!o.length){e.next=5;break}return e.next=5,jt("These arguments are not supported for `"+a+"`: ["+o.map((function(e){return""+e})).join(", ")+"]",63,i,r);case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 1:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),Rr=function(){var e=g(h().mark((function e(t,r,n){var a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=i.load(t.replaceAll(/{{(.*?)}}|{(.*?)}|{%.*%}((.|\n)*){% endfor %}/g,"")),o=Object.values(a.automations).flatMap((function(e){return e.run})),e.next=4,kr(o,r,n);case 4:return e.next=6,wr(o,r,n);case 6:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),_r=function(){var e=g(h().mark((function e(t,r,i){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,(new n.SavedWordsValidator).validate({yamlFile:t}),e.next=8;break;case 4:return e.prev=4,e.t0=e.catch(0),e.next=8,jt(e.t0.message,60,i,r);case 8:case"end":return e.stop()}}),e,null,[[0,4]])})));return function(t,r,n){return e.apply(this,arguments)}}(),Er=function(){var e=g(h().mark((function e(t,r,n){var i,a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.replace(dr,"").replace(vr,""),e.next=3,br(a,r,n);case 3:return e.next=5,xr(a,r,n);case 5:return o=null==(i=a.match(hr))?void 0:i.map((function(e){return e.replace(mr,"").trim()})),e.next=8,yr(o,r,n);case 8:return e.next=10,Rr(a,r,n);case 10:return e.next=12,_r(t,r,n);case 12:case"end":return e.stop()}}),e)})));return function(t,r,n){return e.apply(this,arguments)}}(),Or=["ds_blame","ds_activity"],Sr=function(){var e=g(h().mark((function e(t,r,n,i){var a,o,u,s,c,l,f,p;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=n.repo,e.prev=1,e.next=4,Er(t,i,n);case 4:return o=new We(t,r,Xe),e.next=7,o.parseStreams();case 7:if(!(u=e.sent).automations){e.next=13;break}return s=Object.keys(u.automations).filter((function(e){return u.automations[e].passed})),c=Object.keys(null==u?void 0:u.automations).length,e.next=13,it("info",s.length+" out of "+c+" automations have passed for repo "+a,n,{passedAutomations:s.length,passedAutomationNames:s,totalAutomations:c});case 13:return e.abrupt("return",u);case 16:return e.prev=16,e.t0=e.catch(1),l=n.owner,f=n.repo,p=n.pullRequestNumber,nt("error in parseRules: "+e.t0),e.next=22,it("error","Failed to parse cm in pr "+l+"/"+f+"/"+p,n,{error:null==e.t0?void 0:e.t0.message,rules:t,ruleFile:i});case 22:return e.next=24,jt(null==e.t0?void 0:e.t0.message,60,n,i);case 24:case"end":return e.stop()}}),e,null,[[1,16]])})));return function(t,r,n,i){return e.apply(this,arguments)}}(),jr=function(e){return b({},e,{repo:function(e,t){if(null==e)return{};var r,n,i={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(i[r]=e[r]);return i}(e.repo||{},Or)})},Fr=function(){var e=g(h().mark((function e(t){var r,n,i,a,o,u,s,c,l,f;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.ruleFileContent,n=t.payload,i=t.baseBranch,a=t.refBranch,u=void 0===(o=t.ruleFile)?"playground.cm":o,Gt.cwd=t.cloneRepoPath,e.next=4,Vt(i,a,n,r,u,tr);case 4:return l=or((c=e.sent).repo,c.files,n),nt("expertRequest for cm file: "+u+": "+JSON.stringify(l,null,2)),(s=jr(c)).repo=b({},s.repo,{data_service:{expert_reviwer_request:l}}),f=Ct(r),e.next=12,Sr(f,s,n,u);case 12:return e.abrupt("return",{results:e.sent,context:s,errors:Et});case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Cr=function(){var e=g(h().mark((function e(t){var r,n,i,a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.payload,i=void 0===(n=t.ruleFile)?"playground.cm":n,a=t.cachedContext,o=Ct(t.ruleFileContent),e.next=4,Sr(o,a,r,i);case 4:return e.abrupt("return",{results:e.sent,context:a,errors:Et});case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Nr=function(){var e=g(h().mark((function e(t,r,n,i){var a,o,u,s,c,l,f,p,d,v,m;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=i.owner,o=i.repo,u=i.pullRequestNumber,e.prev=1,s=null==t?void 0:t.validatorErrors,c=null==t?void 0:t.errors,!Object.keys(s||{}).length){e.next=14;break}l=0,f=Object.keys(s);case 6:if(!(l<f.length)){e.next=14;break}return nt("Validator error - "+(p=f[l])+": "+s[p]),e.next=11,it("warn","Validator error - "+p+" in pr "+a+"/"+o+"/"+u,i,{error:""+s[p],ruleFile:r,cmContent:n},!0);case 11:l++,e.next=6;break;case 14:if(!Object.keys(c||{}).length){e.next=25;break}d=0,v=Object.keys(c);case 16:if(!(d<v.length)){e.next=24;break}return nt("Error: "+c[m=v[d]]),e.next=21,jt(c[m],m,i,r);case 21:d++,e.next=16;break;case 24:return e.abrupt("return",!0);case 25:e.next=35;break;case 27:return e.prev=27,e.t0=e.catch(1),nt("Error in parseRulesParserErrors "+(null==e.t0?void 0:e.t0.message)),e.next=32,it("warn","Failed parse rules parser errors in pr "+a+"/"+o+"/"+u,i,{error:""+(null==e.t0?void 0:e.t0.message),ruleFile:r},!0);case 32:return e.next=34,jt("Failed parse rules parser errors: "+(null==e.t0?void 0:e.t0.message),73,i,r);case 34:return e.abrupt("return",!0);case 35:case"end":return e.stop()}}),e,null,[[1,27]])})));return function(t,r,n,i){return e.apply(this,arguments)}}(),Lr=function(){var e=g(h().mark((function e(t,r,n,i,a,o){var u,s,c,l,f,p;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===o&&(o=null),u={},s={},c=h().mark((function e(){var c,p,d,v,m,g,y,x,w;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c=f[l],e.prev=1,!o){e.next=6;break}p=b({},o[c],{pr:Nt(i.prContext)}),e.next=13;break;case 6:return e.next=8,Vt(r,n,i,t[c],c,a);case 8:v=or((d=e.sent).repo,d.files,i),nt("expertRequest for cm file: "+c+": "+JSON.stringify(v,null,2)),(p=jr(d)).repo=b({},p.repo,{data_service:{expert_reviwer_request:v}});case 13:return p.env=process.env,s[c]=p,m=Ct(t[c]),e.next=18,Sr(m,p,i,""+c);case 18:return g=e.sent,e.next=21,Nr(g,c,m,i);case 21:if(!e.sent){e.next=24;break}return e.abrupt("return",{v:{}});case 24:return e.next=26,pr(g.analytics,i,p);case 26:u=Object.keys(g.automations).reduce((function(e,t){var r,n,a=(null==c||null==(r=c.replace(".cm/",""))?void 0:r.replace(".cm",""))||c,o=!(null!=c&&c.includes(".cm/"));return b({},e,((n={})[a+"/"+t]=b({},g.automations[t],{is_org_level:o,provider_repository_id:o?i.cmRepoId:i.providerRepoId}),n))}),u),e.next=37;break;case 29:return e.prev=29,e.t0=e.catch(1),nt("parseMultipleRuleFiles error: "+e.t0.message),y=i.owner,x=i.repo,w=i.pullRequestNumber,e.next=35,it("error","Failed to parse cm in pr "+y+"/"+x+"/"+w,i,{error:null==e.t0?void 0:e.t0.message,rules:t,ruleFile:c});case 35:return e.next=37,jt("Failed to parse cm",66,i,c);case 37:case"end":return e.stop()}}),e,null,[[1,29]])})),l=0,f=Object.keys(t);case 5:if(!(l<f.length)){e.next=13;break}return e.delegateYield(c(),"t0",7);case 7:if("object"!=typeof(p=e.t0)){e.next=10;break}return e.abrupt("return",p.v);case 10:l++,e.next=5;break;case 13:return e.abrupt("return",{automations:u,contextPerFile:s});case 14:case"end":return e.stop()}}),e)})));return function(t,r,n,i,a,o){return e.apply(this,arguments)}}(),Ar=function(){var e=g(h().mark((function e(t,r,n){var i,a,o,u,s,c,l,f,p,d,v,m,g,b,y,x;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=n.cmRepoRef,s="cm"===(null==(u=n.repo)?void 0:u.toLowerCase())?"":".cm/gitstream.cm",c=Ht(s,t),e.next=6,Tt(n,c,s);case 6:if(f=(null==(l=e.sent)||null==(i=l.config)||null==(a=i.admin)?void 0:a.users)||[],!r){e.next=14;break}return v=Ht("gitstream.cm",o,ut.CM),e.next=12,Tt(n,v,"gitstream.cm");case 12:f=f.concat((null==(m=e.sent)||null==(p=m.config)||null==(d=p.admin)?void 0:d.users)||[]);case 14:return g=Array.from(new Set(f)),e.abrupt("return",g);case 18:return e.prev=18,e.t0=e.catch(0),b=n.owner,y=n.repo,x=n.pullRequestNumber,e.next=23,it("warn","gitstream.cm file not found - failed to extract admins in pr "+b+"/"+y+"/"+x,n,{error:null==e.t0?void 0:e.t0.message},!0);case 23:return console.warn("gitstream.cm file not found - failed to extract admins"),e.abrupt("return",[]);case 25:case"end":return e.stop()}}),e,null,[[0,18]])})));return function(t,r,n){return e.apply(this,arguments)}}(),Ir=function(e,t,r){var n=tr(e,t,r);return{cmChanged:n,isDryRun:n&&function(e,t,r){return Ut("git config --global --add safe.directory '*'"),"cm"===(null==r?void 0:r.toLowerCase())?Boolean(Ut("git diff '"+t+"'...'"+e+"' -- ':!*.cm'")):Boolean(Ut("git diff '"+t+"'...'"+e+"' -- ':!.cm/*.cm'"))}(e,t,r)}},Br=function(){var e=g(h().mark((function e(t,r,n,i,a){var o,u,s,c,l,f;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=i.repo,u=i.cmRepoRef,e.next=4,Xt(t?r:n,o);case 4:if(s=e.sent,!a||"cm"===(null==o?void 0:o.toLowerCase())){e.next=12;break}return c=Kt(u),e.next=9,$t(c,o,i);case 9:for(l=x(e.sent);!(f=l()).done;)delete c[f.value];s=b({},c,s);case 12:return e.abrupt("return",s);case 15:return e.prev=15,e.t0=e.catch(0),nt(e.t0.message),e.abrupt("return",{});case 19:case"end":return e.stop()}}),e,null,[[0,15]])})));return function(t,r,n,i,a){return e.apply(this,arguments)}}(),Tr=function(){var e=g(h().mark((function e(t,r,n,i,a){var o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Br(t,r,n,i,a);case 2:if(o=e.sent,Object.keys(o).length){e.next=8;break}return e.next=6,it("warn","Rule file not found",i,{error:"Rule file not found"},!0);case 6:return e.next=8,jt("Rule file not found",70,i);case 8:return e.abrupt("return",o);case 9:case"end":return e.stop()}}),e)})));return function(t,r,n,i,a){return e.apply(this,arguments)}}(),Dr=function(e,t){return Object.values(et).reduce((function(r,n){var i;return e[t].includes("pr."+n)?b({},r,((i={})[n]=!0,i)):r}),{})},Pr=function(e,t){return Object.keys(tt).reduce((function(r,n){var i;return tt[n].test(e[t])?b({},r,((i={})[n]=!0,i)):r}),{})},qr=function(){var e=g(h().mark((function e(t,r){var n,i,a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=Object.keys(t).reduce((function(e,r){var n=Dr(t,r),i=Pr(t,r);return{events:b({},null==e?void 0:e.events,n),filters:b({},null==e?void 0:e.filters,i)}}),{}),e.abrupt("return",n);case 5:return e.prev=5,e.t0=e.catch(0),i=r.owner,a=r.repo,o=r.pullRequestNumber,e.next=10,it("warn","Failed to get watchers from rules files in pr "+i+"/"+a+"/"+o,r,{error:null==e.t0?void 0:e.t0.message},!0);case 10:return e.next=12,jt("Failed to get watchers from rules files",71,r);case 12:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t,r){return e.apply(this,arguments)}}(),Mr=function(){var e=g(h().mark((function e(t){var r,n,i;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.context,n=t.payload,i=Ct(t.ruleFileContent),e.next=5,Sr(i,r,n,"playground.cm");case 5:return e.abrupt("return",{results:e.sent,errors:Et});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),Vr=function(){try{return Ut("git config --global --add safe.directory '*'"),!0}catch(e){return ut.DEFAULT=".",!1}},Gr=function(){var e=g(h().mark((function e(t,r,n,i){var a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=Ir(r,n,t.repo),e.next=4,Tr(a.cmChanged,r,n,t,i);case 4:return o=e.sent,e.next=7,Ar(n,i,t);case 7:return e.abrupt("return",{cmState:a,rules:o,admins:e.sent,cache:{}});case 9:case"end":return e.stop()}}),e)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),Ur=function(){var e=g(h().mark((function e(t,r,n,i){var a,o;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!ze){e.next=10;break}if(a=nr(),Object.keys(a)){e.next=6;break}return e.next=5,jt("Invalid cache",72,{});case 5:return e.abrupt("return",e.sent);case 6:return e.abrupt("return",{cache:a,rules:a.rules,admins:a.admins,cmState:a.cmState});case 10:return e.next=12,Gr(t,r,n,i);case 12:return e.abrupt("return",{rules:(o=e.sent).rules,admins:o.admins,cmState:o.cmState,cache:o.cache});case 18:case"end":return e.stop()}}),e)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),Jr=function(){var e=g(h().mark((function e(t,r,n){return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.post(Ye,JSON.stringify(t),{headers:{"Content-Type":"application/json","x-api-key":Ke}});case 3:return e.next=5,it("info","Sending evaluated rules to the resolver succeeded",r);case 5:console.log({parserResults:JSON.stringify(n)}),e.next=15;break;case 8:return e.prev=8,e.t0=e.catch(0),e.next=12,it("error","Failed sending evaluated rules to the resolver.",r,{error:null==e.t0?void 0:e.t0.message,body:t});case 12:return console.error("Failed sending evaluated rules to the resolver.",{error:e.t0}),e.next=15,jt(null==e.t0?void 0:e.t0.message,50,r);case 15:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t,r,n){return e.apply(this,arguments)}}(),Wr=function(){var e=g(h().mark((function e(){var t,r,n,i,a,o,u,s,c,l,f,p,d,v,m,g,y,x,w,k,R;return h().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=(He||"").trim(),r=(Qe||"").trim(),n="string"==typeof JSON.parse($e)?JSON.parse(JSON.parse($e)):JSON.parse($e),e.prev=3,i=n.repo,a=n.owner,o=n.pullRequestNumber,u=n.headSha,s=n.hasCmRepo,c=Vr()&&s,console.log("PR: "+a+"/"+i+"/pull/"+o+"\ncommit: "+u),e.next=9,Ur(n,t,r,c);case 9:return f=(l=e.sent).rules,p=l.admins,d=l.cmState,v=l.cache,e.next=16,Lr(f,r,t,n,d.cmChanged,v.contextPerFile);case 16:return g=(m=e.sent).automations,rr({contextPerFile:m.contextPerFile,rules:f,admins:p,cmState:d}),e.next=22,qr(f,n);case 22:return x={automations:g,context:b({watchPREvents:(y=e.sent).events,watchFilters:y.filters},n,{admins:p,dryRun:d.isDryRun,onlyRulesFilesChanges:d.cmChanged&&!d.isDryRun},(h=n.source,_={baseBranch:r},E=void 0,E={gitlab:function(e){return{performNonSoftCommands:!1}}}[h],(E?E(_):null)||{}))},e.next=26,Jr(x,n,g);case 26:e.next=36;break;case 28:return e.prev=28,e.t0=e.catch(3),w=n.owner,k=n.repo,R=n.pullRequestNumber,console.error("gitstream-rules-engine internal error",{error:e.t0}),e.next=34,it("warn","gitstream-rules-engine internal error for pr "+w+"/"+k+"/"+R,n,{error:null==e.t0?void 0:e.t0.toString()});case 34:return e.next=36,jt(null==e.t0?void 0:e.t0.toString(),68,n);case 36:case"end":return e.stop()}var h,_,E}),e,null,[[3,28]])})));return function(){return e.apply(this,arguments)}}();console.log("Running gitstream-rules-engine 1.2.3");var Yr=!1;exports.RuleParser=We,exports.RulesEngine=function(e){return void 0===e&&(e=!1),Yr=e,{run:Wr,executeOneRuleFile:Fr,executeCached:Cr,executeParser:Mr}};
//# sourceMappingURL=gitstream-core.cjs.production.min.js.map
