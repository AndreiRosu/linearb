"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("js-yaml"),n=require("nunjucks"),r=e(require("lodash")),i=e(require("axios")),u=e(require("moment")),o=e(require("prettier")),a=require("child_process");function s(){s=function(){return e};var e={},t=Object.prototype,n=t.hasOwnProperty,r="function"==typeof Symbol?Symbol:{},i=r.iterator||"@@iterator",u=r.asyncIterator||"@@asyncIterator",o=r.toStringTag||"@@toStringTag";function a(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{a({},"")}catch(e){a=function(e,t,n){return e[t]=n}}function c(e,t,n,r){var i=Object.create((t&&t.prototype instanceof d?t:d).prototype),u=new k(r||[]);return i._invoke=function(e,t,n){var r="suspendedStart";return function(i,u){if("executing"===r)throw new Error("Generator is already running");if("completed"===r){if("throw"===i)throw u;return{value:void 0,done:!0}}for(n.method=i,n.arg=u;;){var o=n.delegate;if(o){var a=w(o,n);if(a){if(a===f)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if("suspendedStart"===r)throw r="completed",n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r="executing";var s=l(e,t,n);if("normal"===s.type){if(r=n.done?"completed":"suspendedYield",s.arg===f)continue;return{value:s.arg,done:n.done}}"throw"===s.type&&(r="completed",n.method="throw",n.arg=s.arg)}}}(e,n,u),i}function l(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var f={};function d(){}function p(){}function v(){}var h={};a(h,i,(function(){return this}));var g=Object.getPrototypeOf,m=g&&g(g(_([])));m&&m!==t&&n.call(m,i)&&(h=m);var y=v.prototype=d.prototype=Object.create(h);function x(e){["next","throw","return"].forEach((function(t){a(e,t,(function(e){return this._invoke(t,e)}))}))}function b(e,t){var r;this._invoke=function(i,u){function o(){return new t((function(r,o){!function r(i,u,o,a){var s=l(e[i],e,u);if("throw"!==s.type){var c=s.arg,f=c.value;return f&&"object"==typeof f&&n.call(f,"__await")?t.resolve(f.__await).then((function(e){r("next",e,o,a)}),(function(e){r("throw",e,o,a)})):t.resolve(f).then((function(e){c.value=e,o(c)}),(function(e){return r("throw",e,o,a)}))}a(s.arg)}(i,u,r,o)}))}return r=r?r.then(o,o):o()}}function w(e,t){var n=e.iterator[t.method];if(void 0===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=void 0,w(e,t),"throw"===t.method))return f;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return f}var r=l(n,e.iterator,t.arg);if("throw"===r.type)return t.method="throw",t.arg=r.arg,t.delegate=null,f;var i=r.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=void 0),t.delegate=null,f):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,f)}function E(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(E,this),this.reset(!0)}function _(e){if(e){var t=e[i];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,u=function t(){for(;++r<e.length;)if(n.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=void 0,t.done=!0,t};return u.next=u}}return{next:j}}function j(){return{value:void 0,done:!0}}return p.prototype=v,a(y,"constructor",v),a(v,"constructor",p),p.displayName=a(v,o,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===p||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,v):(e.__proto__=v,a(e,o,"GeneratorFunction")),e.prototype=Object.create(y),e},e.awrap=function(e){return{__await:e}},x(b.prototype),a(b.prototype,u,(function(){return this})),e.AsyncIterator=b,e.async=function(t,n,r,i,u){void 0===u&&(u=Promise);var o=new b(c(t,n,r,i),u);return e.isGeneratorFunction(n)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},x(y),a(y,o,"Generator"),a(y,i,(function(){return this})),a(y,"toString",(function(){return"[object Generator]"})),e.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},e.values=_,k.prototype={constructor:k,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=void 0,this.done=!1,this.delegate=null,this.method="next",this.arg=void 0,this.tryEntries.forEach(R),!e)for(var t in this)"t"===t.charAt(0)&&n.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=void 0)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(n,r){return o.type="throw",o.arg=e,t.next=n,r&&(t.method="next",t.arg=void 0),!!r}for(var i=this.tryEntries.length-1;i>=0;--i){var u=this.tryEntries[i],o=u.completion;if("root"===u.tryLoc)return r("end");if(u.tryLoc<=this.prev){var a=n.call(u,"catchLoc"),s=n.call(u,"finallyLoc");if(a&&s){if(this.prev<u.catchLoc)return r(u.catchLoc,!0);if(this.prev<u.finallyLoc)return r(u.finallyLoc)}else if(a){if(this.prev<u.catchLoc)return r(u.catchLoc,!0)}else{if(!s)throw new Error("try statement without catch or finally");if(this.prev<u.finallyLoc)return r(u.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var u=i;break}}u&&("break"===e||"continue"===e)&&u.tryLoc<=t&&t<=u.finallyLoc&&(u=null);var o=u?u.completion:{};return o.type=e,o.arg=t,u?(this.method="next",this.next=u.finallyLoc,f):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),R(n),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;R(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:_(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=void 0),f}},e}function c(e,t,n,r,i,u,o){try{var a=e[u](o),s=a.value}catch(e){return void n(e)}a.done?t(s):Promise.resolve(s).then(r,i)}function l(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var u=e.apply(t,n);function o(e){c(u,r,i,o,a,"next",e)}function a(e){c(u,r,i,o,a,"throw",e)}o(void 0)}))}}function f(){return(f=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}var d,p="https://workerb.linearb.io",v={REVIEW_TIME:p+"/v1/pulls/review-time",EXPERT_REVIWER:p+"/gs/v1/data-service/expert-reviewer"},h=["reviewers","reviewers","team_reviewers","labels"],g=function(e,t){return null==e?void 0:e.includes(t)},m=function(e,t,n){return void 0===n&&(n=!1),"string"==typeof t&&t.startsWith("r/")&&(t=(t=t.substring(2).slice(0,-1)).replace("\\/","/")),new RegExp(t,n?"m":"").test(e)},y=function(e,t){var n=null==e?void 0:e.map((function(e){return Boolean(e)}));return!(null==n||!n.length)&&n.every((function(e){return e===t}))},x=function(e){return"string"==typeof e?e.includes(",")?e.split(","):[e]:null!=e?e:[]},b=((d={}).github="GitHub",d.gitlab="GitLab",d.bitbucket="BitBucket","\n \nTo learn more about /:\\ gitStream - [Visit our Docs](https://docs.gitstream.cm/) \n \n"),w={"01":"JAN","02":"FEB","03":"MAR","04":"APR","05":"MAY","06":"JUN","07":"JUL","08":"AUG","09":"SEP",10:"OCT",11:"NOV",12:"DEC"},E=function(){};E.filters={};var R,k,_=function(e,t){var n;E.filters=f({},E.filters,((n={})[e]={args:t},n))},j=function(e,t,n,r,i){return n?g(t?e[t]:e,n):r?m(t?e[t]:e,r):i.some((function(n){return g(t?e[t]:e,n)}))},O=function(e,t,n,r){void 0===r&&(r=!1);var i=t.attr||"",u=t.term,o=t.regex,a=t.list,s=x(e);if(!u&&!o&&!a)return[];var c=a;return a&&(c=x(a)),"filterList"===n?function(e,t,n,r,i,u){return e.filter((function(e){return u?!j(e,t,n,r,i):j(e,t,n,r,i)}))}(s,i,u,o,c,r):function(e,t,n,r,i,u){return e.map((function(e){return u?!j(e,t,n,r,i):j(e,t,n,r,i)}))}(s,i,u,o,c,r)};!function(e){e.some="some",e.every="every",e.filter="filter",e.includes="includes",e.reject="reject",e.map="map",e.match="match",e.nope="nope"}(k||(k={}));var L,F,I,S,B,T=((R={})[k.some]=function(e){var t;_(k.some,[]);var n=null==(t=x(e))?void 0:t.map((function(e){return Boolean(e)}));return Boolean(null==n?void 0:n.length)&&n.some((function(e){return e}))},R[k.every]=function(e){return _(k.every,[]),y(x(e),!0)},R[k.filter]=function(e,t){return _(k.filter,[t]),O(e,t,"filterList")},R[k.reject]=function(e,t){return _(k.reject,[t]),O(e,t,"filterList",!0)},R[k.map]=function(e,t){var n=t.attr;return _(k.map,[{attr:n}]),x(e).map((function(e){return e[n]}))},R[k.includes]=function(e,t){_(k.includes,[t]);var n=t.term,r=t.regex,i=t.list;if(!n&&!r&&!i)return!1;var u=i;return i&&(u=x(i)),n?g(e,n):r?m(e,r):u.some((function(t){return e.includes(t)}))},R[k.match]=function(e,t){return _(k.match,[t]),O(e,t,"mapList")},R[k.nope]=function(e){return _(k.match,[]),y(x(e),!1)},R),D={github:"",gitlab:"  \n",default:""},P=function(e,t){return Object.keys(e).reduce((function(n,r){var i,u,o=e[r];return n[t[r]]&&(o=e[r]+n[t[r]]),f({},n,((u={})[null!=(i=t[r])&&i.includes("@")||!t[r]?r+"\\*":t[r]]=o,u))}),{})},G=function(e){return{blame:Object.keys(e.blame).reduce((function(t,n){var r;return f({},t,((r={})[n]=P(e.blame[n],e.git_to_provider_user),r))}),{})}},C=function(e,t){var n=Object.keys(t).length;return e.reduce((function(e,r){var i,u=function(e,t){return Object.values(e).reduce((function(e,n){var r,i,u=n[t],o=(null!=u?u:0)+(null!=(r=e[t])?r:0);return f({},e,o&&((i={})[t]=o,i))}),{})}(t,r);return f({},e,u[r]&&((i={})[r]=u[r]/n,i))}),{})},A=function(e,t){return e.sort((function(e,n){var r,i;return(null!=(r=t[n])?r:0)-(null!=(i=t[e])?i:0)}))},N=function(e,t,n){return Object.keys(e).length?function(e,t,n){var r=Object.keys(e).filter((function(r){return void 0!==t?e[r]>t:e[r]<n}));return A(r,e).reduce((function(t,n){var r;return n.includes("*")?t:f({},t,((r={})[n]=e[n],r))}),{})}(e,t,n):{}},M=function(e){return!!e.gt||!!e.lt},W=function(){var e=l(s().mark((function e(t){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,i.post(v.REVIEW_TIME,t,{headers:{"Content-type":"application/json"}});case 2:return e.abrupt("return",{numericValue:e.sent.data.numericValue});case 5:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),J=function(){var e=l(s().mark((function e(t){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=6;break}return e.next=3,i.post(v.EXPERT_REVIWER,t,{headers:{"Content-type":"application/json"}});case 3:return e.abrupt("return",e.sent.data||{});case 6:return e.abrupt("return",{});case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),q=function(e,t,n,r){var i=Object.keys(e).reduce((function(i,u){var o;return(void 0!==t?e[u][r]>t/100:e[u][r]<n/100)?f({},i,((o={})[u]=e[u],o)):i}),{});return Object.keys(i).filter((function(e){return!e.includes("@")&&!e.includes("<>")}))||[]},V=function(e){return e.gt||e.lt||.1},H=function(){var e=l(s().mark((function e(t){var n,r,i,u;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,J(null==(n=t.data_service)?void 0:n.expert_reviwer_request);case 2:if(r=e.sent,Object.keys(r).length){e.next=5;break}return e.abrupt("return",{data:{},dataWithoutIssuer:{},isIssuerFiltered:!1});case 5:return i=!1,u=Object.keys(r).reduce((function(e,n){var u;return n===t.pr_author?(i=!0,e):f({},e,((u={})[n]=r[n],u))}),{}),e.abrupt("return",{data:r,dataWithoutIssuer:u,isIssuerFiltered:i});case 8:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),U=function(e,t,n,r,i,u){var o="🥷 **Code experts:";return o+=e.length?" "+e.join(", ")+"** \n \n":" no user "+(u?"but you":"")+" matched threshold "+r+"** \n \n",t.length&&(o+=t.join(", ")+" "+(1===t.length?"has":"have")+" most 👩‍💻 **activity** in the files. \n"+(D[i]||D.default)),n.length&&(o+=n.join(", ")+" "+(1===n.length?"has":"have")+" most 🧠 **knowledge** in the files. \n"),o},Y=function(e,t,n,r,i,o){try{var a="<details>\n <summary>See details</summary>\n\n";return e.forEach((function(e){a+="\n`"+e+"` \n "+function(e,t,n){return Object.keys(t).length?n.length?"\n\nActivity based on git-commit: \n\n |  | "+(n[0]?n[0]:" ")+" | "+(n[1]?n[1]+"| \n | --- | --- | --- | \n ":" \n | --- | --- | \n")+function(e,t,n){for(var r="",i=[],o=0;o<6;o++)i.push(w[u().subtract(o,"months").format("MM")]);return i.forEach((function(i){var u,o=e[t][n[0]][i],a=null==(u=e[t][n[1]])?void 0:u[i];r+="| "+i+" | "+(o?o.additions+" additions & "+o.deletions+" deletions":" ")+" |",r+=(a?a.additions+" additions & "+a.deletions+" deletions |":" ")+" \n"})),r}(t,e,n):"":"\n\nNo activity in the last 6 months\n\n"}(e,t,r)+" \n\nKnowledge based on git-blame: \n "+(D[o]||D.default)+function(e,t,n,r){var i="";return A(n,t[e]).forEach((function(n){i+=t[e][n]?n+": "+t[e][n]+"% \n"+(D[r]||D.default):""})),i}(e,n,i,o)})),a+="\n</details>\n"}catch(e){return console.log("Error in creating explain code experts comment",e),""}},Q=function(e,t){return Object.keys(e||{}).reduce((function(n,r){var i,u=function(e,t,n){return n.reduce((function(n,r){var i,u=function(e,t,n){return Object.keys(e[t]).reduce((function(r,i){var u,o;return e[t][i][n]?f({},r,((o={})[w[null==(u=i.split("-"))?void 0:u[1]]]=e[t][i][n],o)):r}),{})}(e,t,r);return f({},n,((i={})[r]=u,i))}),{})}(e,r,t);return f({},n,((i={})[r]=u,i))}),{})},Z=function(e,t){return Object.keys(e||{}).reduce((function(n,r){var i,u=A(t,e[r]).reduce((function(t,n){var i;return e[r][n]?f({},t,((i={})[n]=Math.round(100*e[r][n]),i)):t}),{});return f({},n,((i={})[r]=u,i))}),{})},z=function(){var e=l(s().mark((function e(t,n){var r,i,u,o,a,c,l,f,d;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _(B.estimatedReviewTime,[]),o=null==(r=t.diff)?void 0:r.files_metadata.length,a=null==(i=t.diff)?void 0:i.files_metadata.reduce((function(e,t){return e.additionalLines+=t.additions,e.deletedLines+=t.deletions,e}),{additionalLines:0,deletedLines:0}),c=a.additionalLines,l=a.deletedLines,f=null==(u=t.diff)?void 0:u.files_metadata.map((function(e){return{file_path:"/dev/null"!==e.new_file?e.new_file:e.original_file,additions:e.additions,deletions:e.deletions}})),d={prMetadata:{commits:t.num_of_commits,files:o,lines:c+l},prFiles:f,prAdditionalLines:c,prDeletedLines:l,baseBranch:t.base,request_source:"gitstream"},e.next=7,W(d);case 7:n(null,e.sent.numericValue);case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),X=function(){var e=l(s().mark((function e(t,n,r){var i,u,o,a,c,l;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u=void 0===(i=n.gt)?0:i,a=void 0===(o=n.lt)?0:o,e.prev=1,_(B.expertReviewer,[{gt:u,lt:a}]),e.next=5,H(t);case 5:c=e.sent.dataWithoutIssuer,Object.keys(c).length||r(null,[]),l=q(c,u,a,"reviewer_score").slice(0,2),r(null,l),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(1),console.log("error:",e.t0),r(null,[]);case 16:case"end":return e.stop()}}),e,null,[[1,12]])})));return function(t,n,r){return e.apply(this,arguments)}}(),K=function(){var e=l(s().mark((function e(t,n,r){var i,u,o,a,c,l,f,d,p,v,h,g,m,y,x;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=n.gt,a=n.lt,e.next=4,H(t);case 4:l=(c=e.sent).data,f=c.dataWithoutIssuer,d=c.isIssuerFiltered,Object.keys(l).length&&Object.keys(f).length||r(null,[]),p=q(f,o,a,"reviewer_score").slice(0,2),v=q(l,o,a,"avg_activity_score").slice(0,2),h=q(l,o,a,"avg_blame_perc").slice(0,2),g=Q(null==(i=l.explain)?void 0:i.activity,v),m=Z(null==(u=l.explain)?void 0:u.blame,h),y=U(p,v,h,V(n),t.provider,d&&!Object.keys(p).length)+" "+Y(Array.from(new Set([].concat(Object.keys(g),Object.keys(m)))),g,m,v,h,t.provider)+" \n\n "+b+" \n",x="base64: "+Buffer.from(y).toString("base64"),r(null,x),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(0),console.log("error:",e.t0),r("");case 23:case"end":return e.stop()}}),e,null,[[0,19]])})));return function(t,n,r){return e.apply(this,arguments)}}(),$=function(){var e=l(s().mark((function e(t,n,r){var i,u,o,a;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _(B.codeExperts,[{gt:u=void 0===(i=n.gt)?0:i,lt:a=void 0===(o=n.lt)?0:o}]),e.next=4,X(t,{gt:u,lt:a},r);case 4:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),ee=function(){var e=l(s().mark((function e(t,n,r){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _(B.explainExpertReviewer,[n]),e.next=3,K(t,n,r);case 3:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),te=function(){var e=l(s().mark((function e(t,n,r){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _(B.explainCodeExperts,[n]),e.next=3,K(t,n,r);case 3:case"end":return e.stop()}}),e)})));return function(t,n,r){return e.apply(this,arguments)}}(),ne=function(e){return e.replace(/\s+/g," ").replaceAll("'",'"').trim()},re=function(e,t){return ne(o.format(e,{semi:!1,singleQuote:!0,filepath:t}))},ie={js:re,ts:re,html:re,py:function(e){return a.spawnSync("python",["-c","import black; print(black.format_str("+JSON.stringify(e)+", mode=black.FileMode()))"]).stdout.toString().replace(/^\s*[\r\n]/gm,"")},default:ne},ue=function(e,t){var n,i=null!=(n=t.split(".").pop())?n:"";return r.get(ie,i,ie.default)(e,t)},oe=/\[\d+ Bugs?\]/g,ae=/\[\d+ Vulnerabilit(?:ies|y)\]/g,se=/\[\d+ Security Hotspots?\]/g,ce=/\[\d+ Code Smells?\]/g,le=/\[(\d+(\.\d+)?|\.\d+)%\]/g,fe=/\[(\d+(\.\d+)?|\.\d+)%\]/g,de=/!\[([A-Z])\]/g,pe=function(e){var t,n=null==(t=e.match(de))?void 0:t[0];return(null==n?void 0:n.substring(n.lastIndexOf("[")+1,n.indexOf("]")))||""},ve=function(e,t,n){var r,i,u;void 0===n&&(n=!1);var o=null!=(r=n?parseFloat((null==(i=e.match(t))?void 0:i[0].split(/\s+/)[0].replace("[",""))||""):parseInt((null==(u=e.match(t))?void 0:u[0].split(/\s+/)[0].replace("[",""))||""))?r:null;return isNaN(o)?null:o},he=function(e){_(B.sonarParser,[]);var t={bugs:{count:null,rating:""},code_smells:{count:null,rating:""},vulnerabilities:{count:null,rating:""},security_hotspots:{count:null,rating:""},duplications:null,coverage:null},n=e.comments.filter((function(e){return"sonarcloud"===e.commenter}));if(n.length){var r=n[0].content.split("\n");t.bugs={count:ve(r[2],oe),rating:pe(r[2])},t.code_smells={count:ve(r[5],ce),rating:pe(r[5])},t.vulnerabilities={count:ve(r[3],ae),rating:pe(r[3])},t.security_hotspots={count:ve(r[4],se),rating:pe(r[4])},t.duplications=ve(r[8],le,!0),t.coverage=ve(r[7],fe,!0)}return JSON.stringify(t)},ge=function(e){var t=me();return e.conversations.forEach((function(e){var n,r,i,u,o,a,s,c,l,f,d,p,v=e.content.split("\n"),h=null==(n=v[0])||null==(r=n.split("**")[2])?void 0:r.trim(),g=null==(i=v[2])||null==(u=i.split("**")[2])?void 0:u.trim(),m=null==(o=v[4])||null==(a=o.split("**")[2])?void 0:a.trim(),y=null==(s=v[6])||null==(c=s.split("**")[2])?void 0:c.trim(),x=(null!=(l=null==(f=v[10])||null==(d=f.split("<summary>")[1])?void 0:d.split("</summary>")[0])?l:"").replace(/<b>/g,"").replace(/<\/b>/g,"");t.vulnerabilities.push({security_control:h,type:g,description:m,severity:y,summary:x}),t.metrics[y]=(null!=(p=t.metrics[y])?p:0)+1})),t},me=function(){return{vulnerabilities:[],metrics:{HIGH:null,MEDIUM:null,LOW:null,INFO:null}}},ye={extractJitFindings:function(e){_(B.extractJitFindings,[]);var t=function(e){return e.reviews.filter((function(e){return"jit-ci"===e.commenter}))}(e),n=me();if(r.isEmpty(t))return JSON.stringify(n);var i=t.map(ge);return JSON.stringify(function(e,t){return e.reduce((function(e,t){return console.log({acc:e,review:t}),f({},e,{vulnerabilities:[].concat(e.vulnerabilities,t.vulnerabilities),metrics:r.mergeWith(e.metrics,t.metrics,(function(e,t){return(e||0)+(t||0)}))})}),f({},t))}(i,n))}},xe=function(e,t){return!!e.length&&function(e,t){return Boolean(e.length)&&e.map((function(e){return t.some((function(t){return(e||"").includes(t)}))})).every((function(e){return e}))}(e.map((function(e){return e.split(".").pop()||""})),t)},be=function(e,t){if(_(B.rankByGitBlame,[t]),!M(t))return[];var n=t.gt,r=t.lt,i=G(e).blame,u=C(Object.values(e.git_to_provider_user),i),o=N(u,n,r);return Object.keys(o).length?[].concat(Array.from(new Set(Object.keys(o)))):[]};!function(e){e.allDocs="allDocs",e.allImages="allImages",e.allTests="allTests",e.estimatedReviewTime="estimatedReviewTime",e.extensions="extensions",e.isFormattingChange="isFormattingChange",e.matchDiffLines="matchDiffLines",e.isFirstCommit="isFirstCommit",e.rankByGitBlame="rankByGitBlame",e.rankByGitActivity="rankByGitActivity",e.explainRankByGitBlame="explainRankByGitBlame",e.expertReviewer="expertReviewer",e.explainExpertReviewer="explainExpertReviewer",e.codeExperts="codeExperts",e.explainCodeExperts="explainCodeExperts",e.sonarParser="sonarParser",e.mapToEnum="mapToEnum",e.extractSonarFindings="extractSonarFindings",e.extractJitFindings="extractJitFindings"}(B||(B={}));var we,Ee,Re=((L={})[B.allDocs]=["requirements.txt"],L),ke=((F={})[B.allDocs]=["md","mkdown","txt","rst",".adoc"],F[B.allImages]=["svg","png","gif"],F[B.allTests]=["test","spec"],F),_e=f(((I={})[B.allDocs]=function(e){return _(B.allDocs,[]),Boolean(e.length)&&e.every((function(e){return Re[B.allDocs].every((function(t){return!(e.includes("/"+t)||e===t)}))}))&&xe(e,ke[B.allDocs])},I[B.allImages]=function(e){return _(B.allImages,[]),xe(e,ke[B.allImages])},I[B.allTests]=function(e){return _(B.allTests,[]),function(e,t){var n=new RegExp("[^a-zA-Z0-9]("+ke[B.allTests].join("|")+")[^a-zA-Z0-9]");return Boolean(e.length)&&e.map((function(e){return n.test(e||"")})).every((function(e){return e}))}(e)},I[B.estimatedReviewTime]=z,I[B.extensions]=function(e){return _(B.extensions,[]),e.map((function(e){return e.split(".").pop()})).filter((function(e,t,n){return n.indexOf(e)===t}))},I[B.isFormattingChange]=function(e){try{return _(B.isFormattingChange,[]),Boolean(e.length)&&e.every((function(e){var t=e.original_content,n=e.original_file;return ue(e.new_content,e.new_file)===ue(t,n)}))}catch(e){return!1}},I[B.matchDiffLines]=function(e,t){_(B.matchDiffLines,[t]);var n=t.regex,r=t.ignoreWhiteSpaces,i=new RegExp("^[+-]"),u=new RegExp("^[+-]\\s*$");return n?e.map((function(e){return e.diff.split("\n").filter((function(e){return i.test(e)})).filter((function(e){return!r||!u.test(e)})).map((function(e){return m(e,n)}))})).flat(1):[]},I[B.isFirstCommit]=function(e,t){return _(B.isFirstCommit,[{author:t}]),!r.get(e,t,null)},I[B.rankByGitBlame]=be,I[B.rankByGitActivity]=function(e,t){_(B.rankByGitActivity,[t]);var n=t.gt,r=t.lt,i=t.weeks;if(!n&&!r||!i)return[];var u=new Array(i+1).fill(0).map((function(e,t){return"week_"+t})),o=function(e,t){return Object.keys(e).reduce((function(n,r){var i,u=Object.values(e[r]).reduce((function(e,n){return t.forEach((function(t){var r,i=n[t];i&&(e[t]=(null!=(r=e[t])?r:0)+i)})),f({},e)}),{});return f({},n,((i={})[r]=u,i))}),{})}(e.git_activity,u),a=function(e,t,n){return Object.keys(e).reduce((function(r,i){var u,o=Object.keys(e[i]).reduce((function(r,u){var o,a=[];t.forEach((function(t){n[i][t]&&e[i][u][t]&&a.push(e[i][u][t]/n[i][t]*100)}));var s=a.reduce((function(e,t){return e+t}),0)/a.length;return f({},r,a.length&&((o={})[u]=parseInt(null==s?void 0:s.toFixed(0)),o))}),{});return f({},r,((u={})[i]=o,u))}),{})}(e.git_activity,u,o),s=C(Object.keys(e.contributors),a),c=P(s,e.git_to_provider_user),l=N(c,n,r);return Object.keys(l).length?[].concat(Array.from(new Set(Object.keys(l)))):[]},I[B.explainRankByGitBlame]=function(e,t){if(_(B.explainRankByGitBlame,[t]),!M(t))return{};var n=be(e,t),i=r.filter(n,(function(t){return t!==e.pr_author})),u=i.join(", "),o=!i.length&&n.length>0,a=function(e){var t=G(e).blame;return Object.keys(t).reduce((function(e,n){var r;if("/dev/null"===n)return e;var i=A(Object.keys(t[n]),t[n]).reduce((function(e,r){var i;if(!t[n][r])return e;var u=r.replace(/\"\“/g,"").replace("“",""),o=(Math.floor(t[n][r])?Math.floor(t[n][r]):"<1")+"%";return e[u]&&parseInt(e[u])>parseInt(o)&&(o=e[u]),f({},e,((i={})[u]=o,i))}),{});return f({},e,((r={})[n]=i,r))}),{})}(e);return"base64: "+Buffer.from(function(e,t,n,r,i){var u=e.gt,o=u?"more than "+u+"%":"less than "+e.lt+"%",a=Object.keys(n).length,s=function(e,t,n,r){return e?" 👋  **Suggested reviewers: "+e+"**\n \nThey contributed "+t+" of the lines on pre-existing files":" 👋  **Suggested reviewers: no user "+(r?"but you":"")+" matched**\n \nNo "+(n?"other ":"")+"user contributed "+t+" of the lines on pre-existing files"}(t,o,a,i);s+=a?":\n":". \n ",s+=Object.keys(n).length?"<details>\n <summary>See details</summary>\n":"",s+="\n",Object.keys(n).forEach((function(e){0!==Object.keys(n[e]).length&&(s+="\n`"+e+"` \n"+(D[r]||D.default),Object.keys(n[e]).forEach((function(t){s+=t+": "+n[e][t]+" \n"+(D[r]||D.default)})))})),s+="\n</details>\n";var c=Object.values(n).map((function(e){return Object.keys(e).some((function(e){return e.includes("*")}))})).some((function(e){return e}));return s+=c?" \nGit users that could not be automatically mapped are marked with `*`.\n"+(D[r]||D.default)+"To map these users, refer to the instructions [here](https://docs.gitstream.cm/cm-file#config).\n \n":"",s+=b}(t,u,a,e.provider,o)).toString("base64")},I[B.expertReviewer]=X,I[B.explainExpertReviewer]=ee,I[B.codeExperts]=$,I[B.explainCodeExperts]=te,I[B.sonarParser]=he,I[B.mapToEnum]=function(e,t){_(B.mapToEnum,[e,t]);var n=null==t?void 0:t.enum;if(n&&Object.keys(n).length)return n[e]},I[B.extractSonarFindings]=function(e){return _(B.extractSonarFindings,[]),he(e)},I),ye),je=((S={})[B.estimatedReviewTime]=!0,S[B.expertReviewer]=!0,S[B.explainExpertReviewer]=!0,S[B.codeExperts]=!0,S[B.explainCodeExperts]=!0,S),Oe=function(e,t){return e.length&&e.map((function(e){return t.some((function(t){return(e||"").includes(t)}))})).every((function(e){return!0===e}))},Le=function(e){return e.replace(/\s+/g," ").replaceAll("'",'"').trim()};!function(e){e.allExtensions="allExtensions",e.includes="includes",e.allPassRegex="allPassRegex",e.allPathIncludes="allPathIncludes",e.filterRegex="filterRegex",e.includesRegex="includesRegex",e.true="true",e.allFormattingChange="allFormattingChange",e.filterList="filterList",e.filterListRegex="filterListRegex",e.isEveryInListRegex="isEveryInListRegex",e.isSomeInList="isSomeInList",e.isSomeInListRegex="isSomeInListRegex",e.isStringIncludes="isStringIncludes",e.isStringIncludesRegex="isStringIncludesRegex",e.isEveryInList="isEveryInList",e.extractExtensions="extractExtensions",e.isEveryExtension="isEveryExtension",e.isEveryExtensionRegex="isEveryExtensionRegex",e.filterFileDiffRegex="filterFileDiffRegex",e.isEveryLineInFileDiffRegex="isEveryLineInFileDiffRegex",e.isSomeLineInFileDiffRegex="isSomeLineInFileDiffRegex"}(Ee||(Ee={}));var Fe,Ie=((we={})[Ee.filterList]=function(e,t){return!!e.length&&e.filter((function(e){return t.includes(e)}))},we[Ee.filterListRegex]=function(e,t){var n=new RegExp(t);return!!e.length&&e.filter((function(e){return n.test(e)}))},we[Ee.isEveryInListRegex]=function(e,t){var n=new RegExp(t);return!!e.length&&e.map((function(e){return n.test(e)})).every((function(e){return e}))},we[Ee.isSomeInList]=function(e,t){return!!e.length&&e.filter((function(e){return t.includes(e)})).some((function(e){return e}))},we[Ee.isSomeInListRegex]=function(e,t){var n=new RegExp(t);return!!e.length&&e.map((function(e){return n.test(e)})).some((function(e){return e}))},we[Ee.isStringIncludes]=function(e,t){return t.some((function(t){return e.includes(t)}))},we[Ee.isStringIncludesRegex]=function(e,t){return new RegExp(t).test(e)},we[Ee.isEveryInList]=function(e,t){return!!e.length&&e.filter((function(e){return t.includes(e)})).every((function(e){return e}))},we[Ee.extractExtensions]=function(e){return e.length&&e.map((function(e){return e.split(".").pop()})).filter((function(e,t,n){return n.indexOf(e)===t}))},we[Ee.isEveryExtension]=function(e,t){return Oe(e.map((function(e){return e.split(".").pop()||""})).filter((function(e,t,n){return n.indexOf(e)===t})),t)},we[Ee.isEveryExtensionRegex]=function(e,t){var n=new RegExp(t),r=e.map((function(e){return e.split(".").pop()||""})).filter((function(e,t,n){return n.indexOf(e)===t}));return r.length>0&&r.map((function(e){return n.test(e)})).every((function(e){return e}))},we[Ee.true]=function(){return!0},we[Ee.filterFileDiffRegex]=function(e,t){var n=new RegExp(t,"m");return!!e.length&&e.filter((function(e){return n.test(e.diff)}))},we[Ee.isEveryLineInFileDiffRegex]=function(e,t){var n=new RegExp(t,"m");return!!e.length&&e.map((function(e){return n.test(e.diff)})).every((function(e){return e}))},we[Ee.isSomeLineInFileDiffRegex]=function(e,t){var n=new RegExp(t,"m");return!!e.length&&e.map((function(e){return n.test(e.diff)})).some((function(e){return e}))},we[Ee.allExtensions]=function(e,t){return!!e.length&&Oe(e.map((function(e){return e.split(".").pop()||""})),t)},we[Ee.allPassRegex]=function(e,t){var n=new RegExp(t);return!!e.length&&e.map((function(e){return n.test(e)})).every((function(e){return e}))},we[Ee.allPathIncludes]=Oe,we[Ee.filterRegex]=function(e,t){var n=new RegExp(t);return!!e.length&&e.filter((function(e){return n.test(e)}))},we[Ee.includesRegex]=function(e,t){var n=new RegExp(t);return!!e.length&&e.map((function(e){return n.test(e)})).some((function(e){return e}))},we[Ee.allFormattingChange]=function(e){try{return e.every((function(e){var t=e.original_content,n=e.original_file,r=o.format(e.new_content,{semi:!1,singleQuote:!0,filepath:e.new_file}),i=o.format(t,{semi:!1,singleQuote:!0,filepath:n});return Le(r)===Le(i)}))}catch(e){return!1}},we);!function(e){e.cbLeft="_GITSTREAM_CB_LEFT_",e.cbRight="_GITSTREAM_CB_RIGHT_",e.automations="automations",e.errors="errors",e.analytics="analytics"}(Fe||(Fe={})),exports.RuleParser=function(){function e(e,t,r){var i=this;this.renderedRuleFile={},this.context={},this.lastParserResult={},this.isDebug=r,this.env=new n.Environment(new n.FileSystemLoader(__dirname),{autoescape:!1});var u=f({},T,_e,Ie);Object.keys(u).forEach((function(e){i.env.addFilter(e,u[e],je[e])})),this.context=t,this.ruleFileRawContent=e,this.isDebug&&console.log({context:JSON.stringify(this.context,null,2),ruleFile:e})}var r=e.prototype;return r.render=function(){var e=l(s().mark((function e(n){var r,i,u,o=this;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:void 0===n&&(n=f({},this.context,this.renderedRuleFile)),r=3,i=n,u=s().mark((function e(){var n;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=o.ruleFileRawContent,e.next=3,new Promise((function(e,r){return o.env.renderString(n,i,(function(n,i){if(n)return o.isDebug&&console.log("gitstream-rules-parser - failed render string",n),void r(n);try{o.renderedRuleFile=t.load(i)}catch(e){var u;o.isDebug&&console.log("gitstream-rules-parser - failed yaml.load",e),o.renderedRuleFile=f({},o.renderedRuleFile,{errors:(u={},u[81]="gitstream-rules-parser - failed yaml.load",u)})}e(o)}))}));case 3:r-=1,i=f({},o.context,o.renderedRuleFile);case 5:case"end":return e.stop()}}),e)}));case 4:if(!r){e.next=8;break}return e.delegateYield(u(),"t0",6);case 6:e.next=4;break;case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),r.validateRun=function(e){return e?e.map((function(e){if(!e.args)return e;var t=Object.keys(e.args).reduce((function(t,n){var r,i=e.args[n];return f({},t,((r={})[n]=i&&h.includes(n)&&"string"==typeof i?i.split(","):e.args[n],r))}),{});return f({},e,{args:t})})):e},r.combineMetadataWithRulesResult=function(e){var t=this;return this.renderedRuleFile[e]?Object.keys(this.renderedRuleFile[e]).reduce((function(n,r){var i,u=t.renderedRuleFile[e][r].if.map((function(e){return{passed:e}})),o=u.map((function(e){return e.passed})).every((function(e){return"object"==typeof e?!!Object.keys(e||{}).length:!!e}));return f({},n,((i={})[r]={if:u,run:t.validateRun(t.renderedRuleFile[e][r].run),passed:o},i))}),{}):{}},r.combineMetadataWithResult=function(){var e;return this.lastParserResult=((e={})[Fe.errors]=f({},this.renderedRuleFile[Fe.errors]&&this.renderedRuleFile[Fe.errors]),e[Fe.automations]=f({},this.combineMetadataWithRulesResult(Fe.automations)),e[Fe.analytics]=f({},Object.keys(E.filters).length&&E.filters),e),this.lastParserResult},r.parseStreams=function(){var e=l(s().mark((function e(){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.render();case 2:return e.abrupt("return",this.combineMetadataWithResult());case 3:case"end":return e.stop()}}),e,this)})));return function(){return e.apply(this,arguments)}}(),e}();
//# sourceMappingURL=gitstream-rule-parser.cjs.production.min.js.map
