"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=require("winston"),r=e(require("express-http-context")),n=e(require("lodash")),s=e(require("morgan")),o=require("uuid"),a=require("url");function i(){return(i=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function u(e,t){if(null==e)return{};var r,n,s={},o=Object.keys(e);for(n=0;n<o.length;n++)t.indexOf(r=o[n])>=0||(s[r]=e[r]);return s}var d=["authorization","token","password","code","pass","key","access_token","access_token_secret","refresh_token","accessToken","refreshToken","cookie"],c=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!0);var r=new WeakSet;return function(n,s){if(e&&"object"==typeof s&&null!==s){if(r.has(s))return console.error("Circular Object key detected: "+n),"#CircularRefParentObject";r.add(s)}return t&&d.includes(n)&&"string"==typeof s?s.substring(0,3)+"*****"+s.slice(-1):s}},l=function(e,t,r){try{return JSON.stringify(e,c(!1,t),r)}catch(n){return JSON.stringify(e,c(!0,t),r)}},g=function(e){try{var t=new a.URL(e),r={};return t.searchParams.forEach((function(e,t){r[t]?r[t].push(e):r[t]=[e]})),t.query=r,t}catch(e){return{}}};function f(e,t,s){var a=n.get(e,"headers.id","").toString(),i=n.get(e,"headers.organization_id","").toString(),u=n.get(e,"headers.x-request-id",null),c=n.get(e,"headers.source-x-request-id",null),l=n.get(e,"query.x-request-id",null),g=n.get(e,"query.source-x-request-id",null),f=u||l||o.v4(),p=c||g,m=n.get(e,"headers.x-amzn-trace-id",null);u||(e.headers["x-request-id"]=f),p&&r.set("sourceRequestId",p),r.set("headers",n.omit(e.headers,d)),r.set("body",e.body),r.set("params",e.params),r.set("query",e.query),r.set("originalUrl",e.originalUrl),r.set("method",e.method),r.set("amznTraceId",m),r.set("requestId",f),r.set("accountId",a),r.set("organizationId",i),s()}var p=["level","timestamp","message"],m=["level","timestamp","message","error"],v=t.format.combine,h=t.format.timestamp,y=t.format.printf,x=t.format.colorize,b={consoleLevel:"debug"},q=y((function(e){var t=e.level,r=e.timestamp,n=e.message,s=void 0===n?"":n,o=u(e,p);return l({timestamp:r,level:t,message:s,ctx:o},!0)})),O=y((function(e){var t=e.level,r=e.timestamp,n=e.message,s=void 0===n?"":n,o=e.error,a=u(e,m);return r+" ["+t+"]: "+l({message:s,ctx:a},!1)+"\n"+(o?l(o,!1,2):"")}));function C(e,t){var n;r.set("extendedContext",i({},r.get("extendedContext")||{},((n={})[e]=t,n)))}exports.FIELDS_TO_OMIT=d,exports.SafeStringifyReplacer=l,exports.StringifyReplacer=c,exports.createLogger=function(e){var o=function(e){return void 0===e&&(e={}),Object.assign({},b,process.env,e)}(e),a=o.GIT_COMMIT_SHORT,u=o.app,d=o.environment,c=o.consoleLevel,p=[new t.transports.Console({level:c,handleExceptions:!0})],m=t.createLogger({transports:p,exitOnError:!1,format:d.includes("local")?v(h(),x(),O):v(h(),q),defaultMeta:i({app:u,environment:d},a?{commit_sha:a}:{})}),y=function(e){return function(t,n){var s=r.get("sourceRequestId"),o=r.get("requestId"),a=r.get("accountId"),c=r.get("organizationId"),l=r.get("extendedContext")||{};return e(i({message:t},n,{environment:d,app:u,"x-request-id":o},s?{source_request_id:s}:{},a?{account_id:a}:{},c?{org_id:c}:{},l))}};return{level:c,embed:function(e){e.use(r.middleware),e.use(f),e.use(function(e,t){return s((function(t,n,s){var o,a=r.get("amznTraceId"),u=i({method:t.method(n,s),status:Number(t.status(n,s)),url:t.url(n,s),headers:r.get("headers"),"response-time":t["response-time"](n,s)+" ms","x-request-id":r.get("requestId"),body:r.get("body"),query:r.get("query")},a?((o={})["x-amzn-trace-id"]=a,o):{}),d=(u.url||"").split("?")[0];u.status<400?e.debug("",u):e.error("[Extended log]: "+u.status+" "+u.method+" "+d,u)}),{stream:{write:function(e){}},skip:function(e,r){return r.statusCode>199&&r.statusCode<400&&"debug"!==t}})}(m,c))},debug:function(e,t){void 0===t&&(t={}),y(m.debug)(e,t)},verbose:function(e,t){void 0===t&&(t={}),y(m.verbose)(e,t)},info:function(e,t){void 0===t&&(t={}),y(m.info)(e,t)},warn:function(e,t){void 0===t&&(t={}),y(m.warn)(e,t)},error:function(e,t){void 0===t&&(t={});var s=i({},t);if(t.isAxiosError){var o=g(n.get(t,"config.url","")),a=Object.assign(n.get(o,"query",{}),n.get(t,"config.params",{}));s.httpClientResponseQueryParams=l(a,!0),s.httpClientResponseURL=n.get(t,"config.baseURL","")+n.get(o,"pathname",""),s.httpClientResponseMethod=n.get(t,"config.method",null),s.httpClientResponseStatusCode=n.get(t,"response.status",null),s.httpClientResponseMessage=n.get(t,"response.data.message",null)}var u={headers:r.get("headers"),body:r.get("body"),params:r.get("params"),query:r.get("query"),originalUrl:r.get("originalUrl"),method:r.get("method")};y(m.error)(e,{ctxError:s,request:u})},addContext:C}},exports.parseURL=g;
//# sourceMappingURL=linode-logger.cjs.production.min.js.map
